# CSS Custom Highlight API — Phase 3: Highlight Rendering Swap

**Goal:** Replace char-span-based highlight painting and text selection detection with CSS Custom Highlight API and text-walker-based detection.

**Architecture:** Server sends structured highlight data (tag → char ranges) as JSON to the client via `ui.run_javascript()`. Client JS creates `Highlight` objects with `StaticRange`s built from the text walker's node map, registered in `CSS.highlights`. `::highlight()` pseudo-element CSS provides static per-tag styling. Selection detection moves from `[data-char-index]` queries to text-walker-based `rangePointToCharOffset()`. Char-span injection functions are deleted entirely.

**Tech Stack:** CSS Custom Highlight API (`CSS.highlights`, `Highlight`, `StaticRange`), NiceGUI `ui.run_javascript()`, selectolax (server-side).

**Scope:** Phase 3 of 6 from original design.

**Codebase verified:** 2026-02-12

**Key discrepancy from design plan:** Design assumed 3 named JS constants (`_CHAR_SPANS_JS`, `_TAB_REINJECT_JS`, `_HIGHLIGHT_CSS_JS`). Actually: char span injection is inline JS in `_render_document_with_highlights()` (L1318-1395); highlight CSS is generated by `_build_highlight_css()` (L555-560) producing per-character `[data-char-index="N"]` selectors; no named JS constants for this logic.

---

## Acceptance Criteria Coverage

This phase implements and tests:

### css-highlight-api.AC1: Highlights render via CSS Custom Highlight API
- **css-highlight-api.AC1.1 Success:** Annotation highlights paint with coloured background and underline on the correct text ranges without any `<span class="char">` elements in the DOM
- **css-highlight-api.AC1.2 Success:** Multiple annotation tags (e.g. jurisdiction, legal_issues) render simultaneously with distinct colours via separate `CSS.highlights` entries
- **css-highlight-api.AC1.3 Success:** Highlights spanning across block element boundaries (p, h2, li, blockquote, table cells) render as a single continuous highlight without splitting
- **css-highlight-api.AC1.4 Failure:** Creating a highlight with invalid char offsets (start >= end, negative, beyond document length) logs a warning and is silently skipped — no crash
- **css-highlight-api.AC1.5 Edge:** Overlapping highlights from different tags render with correct priority (both visible through layered opacity)

### css-highlight-api.AC2: Text selection uses JS text walker
- **css-highlight-api.AC2.1 Success:** Selecting text with the mouse produces correct `{start_char, end_char}` offsets matching the server's `document_chars` array
- **css-highlight-api.AC2.2 Success:** Selection across block element boundaries (paragraph into list item, heading into body text) produces correct contiguous char offsets
- **css-highlight-api.AC2.3 Failure:** Selection outside the document container (e.g. in sidebar or toolbar) is ignored — no event emitted
- **css-highlight-api.AC2.4 Edge:** Collapsed selection (click without drag) does not emit a selection event

### css-highlight-api.AC5: Char-span functions removed from public API
- **css-highlight-api.AC5.1 Success:** `inject_char_spans`, `strip_char_spans`, and `extract_chars_from_spans` are not in `input_pipeline.__all__`
- **css-highlight-api.AC5.2 Success:** `from promptgrimoire.input_pipeline import inject_char_spans` raises `ImportError`
- **css-highlight-api.AC5.3 Success:** `extract_text_from_html()` remains available and functional

---

<!-- START_SUBCOMPONENT_A (tasks 1-2) -->
<!-- START_TASK_1 -->
### Task 1: Add highlight rendering and selection functions to annotation-highlight.js

**Verifies:** None (infrastructure — provides functions tested in Task 2 and used by subsequent tasks)

**Files:**
- Modify: `src/promptgrimoire/static/annotation-highlight.js` (add new functions alongside Phase 2's text walker functions)

**Implementation:**

Add the following functions to `annotation-highlight.js`:

1. **`applyHighlights(container, highlightData, tagColors)`** — receives highlight JSON (`{tag: [{start_char, end_char, id}], ...}`) and tag colour map. For each tag:
   - Creates a `Highlight` object
   - For each range in the tag's list, calls `charOffsetToRange(textNodes, startChar, endChar)` to get a `StaticRange`
   - Validates offsets (skip if `start >= end`, negative, or beyond text length — log warning)
   - Adds range to the `Highlight` object
   - Registers in `CSS.highlights.set('hl-' + tag, highlight)` with priority based on tag index

2. **`clearHighlights()`** — removes all `hl-*` entries from `CSS.highlights`

3. **`setupAnnotationSelection(container, emitCallback)`** — mouseup listener that:
   - Gets the browser `Selection` object
   - Checks selection is within `container` (ignore outside selections — AC2.3)
   - Checks selection is not collapsed (ignore clicks without drag — AC2.4)
   - Converts selection Range start/end to char offsets using `rangePointToCharOffset()`
   - Calls `emitCallback({start_char, end_char})`

The `applyHighlights` and `setupSelection` functions from Phase 2's demo page extraction already do most of this. The key changes: `applyHighlights` now receives structured JSON (not demo format), and `setupAnnotationSelection` emits via callback instead of `emitEvent()` (the caller in annotation.py wires the callback to NiceGUI's event system).

**Verification:**
Run: `uv run pytest tests/integration/test_text_walker_parity.py -v` (Phase 2 tests still pass — no regressions)

**Commit:** `feat: add highlight rendering and selection functions to annotation-highlight.js`
<!-- END_TASK_1 -->

<!-- START_TASK_2 -->
### Task 2: Add ::highlight() pseudo-element CSS

**Verifies:** None (infrastructure — CSS styling for highlights)

**Files:**
- Modify: `src/promptgrimoire/pages/annotation.py` — modify `_build_highlight_css()` (currently at ~L555) to generate `::highlight()` rules instead of `[data-char-index]` rules; add static `::highlight()` base styles to `_PAGE_CSS`

**Implementation:**

Replace `_build_highlight_css()` with `_build_highlight_pseudo_css()` that generates CSS like:

```css
::highlight(hl-jurisdiction) {
    background-color: rgba(255, 235, 59, 0.4);
    text-decoration: underline;
    text-decoration-color: #FFEB3B;
}
::highlight(hl-legal_issues) {
    background-color: rgba(244, 67, 54, 0.4);
    text-decoration: underline;
    text-decoration-color: #F44336;
}
```

Note: `::highlight()` supports only `background-color`, `color`, `text-decoration`, `text-shadow`. Cannot use `text-decoration-thickness` or `text-underline-offset` (those are not supported in `::highlight()`). Adjust styling accordingly — use `text-decoration` as progressive enhancement (works in Chrome/Safari, limited in Firefox <146).

Also remove `.char` CSS rules from `_PAGE_CSS` (L255-262, L308-314) and the `.card-hover-highlight` box-shadow rule, since char spans no longer exist.

**Verification:**
Run: `uv run ruff check src/promptgrimoire/pages/annotation.py` (no lint errors)
Run: `uvx ty check` (no type errors)

**Commit:** `refactor: replace per-character CSS with ::highlight() pseudo-element rules`
<!-- END_TASK_2 -->
<!-- END_SUBCOMPONENT_A -->

<!-- START_SUBCOMPONENT_B (tasks 3-4) -->
<!-- START_TASK_3 -->
### Task 3: Rewrite _render_document_with_highlights() to use CSS Custom Highlight API

**Verifies:** css-highlight-api.AC1.1, css-highlight-api.AC1.2, css-highlight-api.AC1.3, css-highlight-api.AC1.4, css-highlight-api.AC1.5

**Files:**
- Modify: `src/promptgrimoire/pages/annotation.py:1241-1500` (`_render_document_with_highlights()`)
- Modify: `src/promptgrimoire/pages/annotation.py` — update selection event handler setup (currently ~L1143-1237)

**Implementation:**

Rewrite `_render_document_with_highlights()` to:

1. Keep: `state.document_chars = extract_text_from_html(doc.content)` (server-side offset computation unchanged)
2. Keep: Loading highlights from CRDT
3. **Replace:** Instead of `_build_highlight_css()` generating per-char CSS, call `_build_highlight_pseudo_css()` for static `::highlight()` rules
4. **Replace:** Instead of injecting `inject_spans_js` (inline JS, L1318-1395), load `annotation-highlight.js` via `ui.add_body_html('<script src="/static/annotation-highlight.js"></script>')` (if not already loaded)
5. **Add:** After page renders (using `ui.timer()` for DOM readiness, matching demo page pattern at L411-417), call `ui.run_javascript()` to:
   - Build text node map: `walkTextNodes(document.querySelector('#doc-container'))`
   - Apply highlights: `applyHighlights(container, highlightData, tagColors)` where `highlightData` is JSON serialised from the CRDT highlights
   - Set up selection: `setupAnnotationSelection(container, (sel) => emitEvent('selection_made', sel))`

6. **Replace:** Selection event handler JS (L1155-1171) — delete the `[data-char-index]` query-based selection code. The `setupAnnotationSelection()` function from the JS module now handles this, emitting `selection_made` with `{start_char, end_char}`.

7. **Keep:** Python `on_selection()` handler (L1101-1109) — it already expects `{start, end}` args, just rename to match new field names (`start_char`, `end_char`)

The highlight update flow for when a user creates/deletes a highlight: server recalculates highlights from CRDT, rebuilds JSON, calls `ui.run_javascript()` with updated `applyHighlights(...)` call. This replaces the current flow of rebuilding `_build_highlight_css()` and updating the `<style>` element innerHTML.

**Testing:**

Tests must verify each AC listed above:
- css-highlight-api.AC1.1: E2E test — create workspace with content, create a highlight, verify no `span.char` elements in DOM and highlight text has correct visual appearance
- css-highlight-api.AC1.2: E2E test — create highlights with two different tags, verify both render with distinct colours
- css-highlight-api.AC1.3: E2E test — create highlight spanning across a paragraph boundary, verify continuous highlight
- css-highlight-api.AC1.4: Unit test — call `applyHighlights()` with invalid offsets via Playwright `page.evaluate()`, verify console warning and no crash
- css-highlight-api.AC1.5: E2E test — create two overlapping highlights with different tags, verify both visible

Test file: `tests/e2e/test_highlight_rendering.py`

**Verification:**
Run: `uv run pytest tests/e2e/test_highlight_rendering.py -v`
Expected: All tests pass

**Commit:** `feat: render annotation highlights via CSS Custom Highlight API`
<!-- END_TASK_3 -->

<!-- START_TASK_4 -->
### Task 4: Rewrite text selection to use text walker

**Verifies:** css-highlight-api.AC2.1, css-highlight-api.AC2.2, css-highlight-api.AC2.3, css-highlight-api.AC2.4

**Files:**
- Modify: `src/promptgrimoire/pages/annotation.py` — selection event handler wiring
- Modify: `src/promptgrimoire/static/annotation-highlight.js` — `setupAnnotationSelection()` already added in Task 1

**Implementation:**

The JS `setupAnnotationSelection()` function (added in Task 1) handles the client-side selection-to-offset conversion. This task wires it into the annotation page:

1. In the `ui.run_javascript()` initialisation call (from Task 3), include `setupAnnotationSelection(container, (sel) => emitEvent('selection_made', sel))`
2. Delete the old JS selection code that queries `[data-char-index]` spans (the inline `js_code` variable in the event setup section ~L1143-1237)
3. Update `on_selection()` to read `e.args.get("start_char")` and `e.args.get("end_char")` (matching the new JS field names)

**Testing:**

Tests must verify each AC listed above:
- css-highlight-api.AC2.1: E2E test — select text with mouse, verify `selection_made` event carries correct char offsets
- css-highlight-api.AC2.2: E2E test — select text across paragraph boundary, verify contiguous offsets
- css-highlight-api.AC2.3: E2E test — select text outside document container (in sidebar), verify no `selection_made` event
- css-highlight-api.AC2.4: E2E test — single click (no drag), verify no `selection_made` event

Test file: `tests/e2e/test_text_selection.py`

**Verification:**
Run: `uv run pytest tests/e2e/test_text_selection.py -v`
Expected: All tests pass

**Commit:** `feat: replace char-span selection with text-walker-based selection detection`
<!-- END_TASK_4 -->
<!-- END_SUBCOMPONENT_B -->

<!-- START_SUBCOMPONENT_C (tasks 5-6) -->
<!-- START_TASK_5 -->
### Task 5: Delete char-span functions from input_pipeline

**Verifies:** css-highlight-api.AC5.1, css-highlight-api.AC5.2, css-highlight-api.AC5.3

**Files:**
- Modify: `src/promptgrimoire/input_pipeline/html_input.py` — delete `inject_char_spans()` (~L160), `strip_char_spans()` (~L329), `extract_chars_from_spans()` (~L347)
- Modify: `src/promptgrimoire/input_pipeline/__init__.py` — remove `inject_char_spans` and `strip_char_spans` from imports and `__all__`
- Delete test code: `tests/unit/input_pipeline/test_char_spans.py` — remove `TestInjectCharSpans`, `TestStripCharSpans`, `TestExtractCharsFromSpans` test classes. Keep `TestExtractTextFromHtml` and `TestStripHtmlToText` (they test functions that remain).

**Implementation:**

1. Delete the three functions from `html_input.py`. Keep `extract_text_from_html()` (L381+) — it's the foundation of the new system.
2. Remove `inject_char_spans` and `strip_char_spans` from `__init__.py` imports and `__all__`. `extract_chars_from_spans` was never in `__all__` so no change needed there.
3. In `test_char_spans.py`, delete the test classes for the removed functions. Keep `TestExtractTextFromHtml` (19 tests) and `TestStripHtmlToText` — rename the file to `test_text_extraction.py` since it no longer tests char spans.
4. Delete the `test_matches_inject_char_spans` parity test — replaced by Phase 2's JS/Python parity test suite.

**Testing:**

Tests must verify each AC listed above:
- css-highlight-api.AC5.1: Unit test — verify `inject_char_spans`, `strip_char_spans`, `extract_chars_from_spans` are NOT in `promptgrimoire.input_pipeline.__all__`
- css-highlight-api.AC5.2: Unit test — `from promptgrimoire.input_pipeline import inject_char_spans` raises `ImportError`
- css-highlight-api.AC5.3: Unit test — `from promptgrimoire.input_pipeline.html_input import extract_text_from_html` works and produces correct output

Test file: `tests/unit/input_pipeline/test_public_api.py`

**Verification:**
Run: `uv run pytest tests/unit/input_pipeline/ -v`
Expected: All remaining tests pass, no import errors

**Commit:** `refactor: remove char-span injection functions from input_pipeline`
<!-- END_TASK_5 -->

<!-- START_TASK_6 -->
### Task 6: Full annotation page integration test

**Verifies:** css-highlight-api.AC1.1, css-highlight-api.AC2.1 (end-to-end verification that highlights + selection work together)

**Files:**
- Create: `tests/e2e/test_annotation_highlight_api.py`

**Implementation:**

End-to-end test that exercises the complete new flow:
1. Navigate to annotation page, create workspace with content
2. Select text → verify `selection_made` event produces correct offsets
3. Create highlight → verify it renders via CSS Custom Highlight API (no `span.char` in DOM)
4. Verify highlight visible on correct text
5. Create second highlight with different tag → verify both visible with distinct colours

This is the integration test that proves the whole Phase 3 works together.

**Testing:**

Combines AC1.1 (highlights render without char spans) and AC2.1 (selection produces correct offsets) in a single user flow.

**Verification:**
Run: `uv run pytest tests/e2e/test_annotation_highlight_api.py -v`
Expected: All tests pass

Run: `uv run test-all` (ensure no regressions across entire test suite)
Expected: All tests pass

**Commit:** `test: add E2E integration test for CSS Custom Highlight API annotation flow`
<!-- END_TASK_6 -->
<!-- END_SUBCOMPONENT_C -->
