\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{promptgrimoire-export}[2026/02/12 PromptGrimoire annotation export]

% =============================================================================
% Package dependencies (converted from \usepackage to \RequirePackage)
% =============================================================================

\RequirePackage{xcolor}

% Unicode support for Emoji (fontspec always needed, luatexja-fontspec conditional)
\RequirePackage{fontspec}
\RequirePackage{emoji}

% Static preamble content
\RequirePackage{amsmath}           % Math extensions (\text{} in math mode)
\RequirePackage{microtype}         % Better typography (kerning, protrusion)
\RequirePackage{marginalia}        % Auto-stacking margin notes for LuaLaTeX
\RequirePackage{longtable}
\RequirePackage{booktabs}
\RequirePackage{array}
\RequirePackage{calc}
\RequirePackage[hidelinks]{hyperref}
\RequirePackage{changepage}
\RequirePackage{luacolor}  % Required by lua-ul for coloured highlights
\RequirePackage{lua-ul}    % LuaLaTeX highlighting (robust across line breaks)
\RequirePackage{luabidi}   % Bidirectional text support for LuaLaTeX
\RequirePackage{fancyvrb}  % Verbatim/code blocks from Pandoc syntax highlighting
\RequirePackage[a4paper,left=2.5cm,right=6cm,top=2.5cm,bottom=2.5cm]{geometry}
\RequirePackage[framemethod=tikz]{mdframed}  % For speaker turn borders

% =============================================================================
% Fixed commands
% =============================================================================

% Stub for \includegraphics - Pandoc converts <img> tags to this.
% hyperref loads graphicx which defines \includegraphics, so we must
% \renewcommand AFTER all \usepackage calls to survive.
\renewcommand{\includegraphics}[2][]{[image]}

% Pandoc compatibility
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% Fallback for emoji not in LaTeX emoji package
% Can't use Noto Color Emoji directly (CBDT format not supported by LuaLaTeX)
% Just show placeholder text for unknown emoji
\newcommand{\emojifallbackchar}[1]{[#1]}

% =============================================================================
% No-op otherlanguage environment
% =============================================================================

% No-op otherlanguage environment - Pandoc generates \begin{otherlanguage}{X}
% for non-English content but we handle multilingual via luatexja + font fallbacks.
% babel (loaded by hyperref/luabidi chain) may define it, so override safely.
\makeatletter
\@ifundefined{otherlanguage}%
  {\newenvironment{otherlanguage}[1]{}{}}%
  {\renewenvironment{otherlanguage}[1]{}{}}
\makeatother

% =============================================================================
% Paragraph formatting
% =============================================================================

% Paragraph formatting for chatbot exports (no indent, paragraph spacing)
\setlength{\parindent}{0pt}
\setlength{\parskip}{0.5\baselineskip}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\setcounter{secnumdepth}{-\maxdimen}  % no section numbering

% =============================================================================
% Static colour definitions
% =============================================================================

% Speaker colours for chatbot turn markers
\definecolor{usercolor}{HTML}{4A90D9}
\definecolor{assistantcolor}{HTML}{7B68EE}
\definecolor{systemcolor}{HTML}{E65100}

% =============================================================================
% Speaker turn environments
% =============================================================================

% Speaker turn environments with left border
\newmdenv[
  topline=false,
  bottomline=false,
  rightline=false,
  linewidth=3pt,
  linecolor=usercolor,
  innerleftmargin=1em,
  innerrightmargin=0pt,
  innertopmargin=0pt,
  innerbottommargin=0pt,
  skipabove=0pt,
  skipbelow=0pt
]{userturn}
\newmdenv[
  topline=false,
  bottomline=false,
  rightline=false,
  linewidth=3pt,
  linecolor=assistantcolor,
  innerleftmargin=1em,
  innerrightmargin=0pt,
  innertopmargin=0pt,
  innerbottommargin=0pt,
  skipabove=0pt,
  skipbelow=0pt
]{assistantturn}
\newmdenv[
  topline=false,
  bottomline=false,
  rightline=false,
  linewidth=3pt,
  linecolor=systemcolor,
  innerleftmargin=1em,
  innerrightmargin=0pt,
  innertopmargin=0pt,
  innerbottommargin=0pt,
  skipabove=0pt,
  skipbelow=0pt
]{systemturn}

% =============================================================================
% Annotation counter and macro
% =============================================================================

% Usage: \annot{colour-name}{margin content}
% Uses footnotesize for compact margin notes
% marginalia auto-stacks overlapping notes with ysep spacing
\newcounter{annotnum}
\newcommand{\annot}[2]{%
  \stepcounter{annotnum}%
  \textsuperscript{\textcolor{#1}{\textbf{\theannotnum}}}%
  \marginalia[ysep=3pt]{%
    \fcolorbox{#1}{#1!20}{%
      \parbox{4.3cm}{\footnotesize\textbf{\theannotnum.} #2}%
    }%
  }%
}

% =============================================================================
% Font setup (static portion -- dynamic font chain built by build_font_preamble())
% =============================================================================

% Emoji font setup
\setemojifont{Noto Color Emoji}

% Safe pass-through default for \cjktext -- overridden by build_font_preamble()
% when CJK text is detected (\renewcommand with \notocjk)
\providecommand{\cjktext}[1]{#1}

\endinput
