# AAF OIDC Authentication Integration Design

**GitHub Issue:** #188, #189

## Summary

PromptGrimoire currently uses Stytch's B2B authentication client with magic links and GitHub OAuth. This work integrates two institutional login methods required for Macquarie University deployment: AAF OIDC (the Australian Access Federation's federated single sign-on service, which MQ staff authenticate through) and Google OAuth (a backstop for MQ students whose institutional credentials flow through Google Workspace). The integration is mediated entirely through Stytch, which acts as the OIDC relay — MQ staff authenticate at AAF's central hub, AAF issues an OIDC token to Stytch, and Stytch creates a session the app can validate. Google OAuth follows the same Stytch-mediated pattern already used for GitHub.

Beyond adding login buttons, this work threads institutional identity attributes (specifically `eduperson_affiliation`, which encodes whether an AAF user is staff or a student) through the auth pipeline into the application's role system. A new `derive_roles_from_metadata()` function reads those attributes from Stytch's `trusted_metadata` field and translates them into app roles (`instructor` vs. unprivileged). Magic link login is simultaneously restricted to MQ email domains as a security measure. Six sequential phases structure the work: diagnosing why the existing (but broken) AAF OIDC connection in Stytch fails, plumbing the role-mapping pipeline, adding the Google OAuth UI, enforcing magic link domain restrictions, cutting over to production AAF credentials, and documenting a fallback path to Stytch B2C in case the B2B approach proves unworkable.

## Definition of Done

1. **AAF OIDC login works end-to-end** — MQ staff can click "Login with AAF", authenticate via their institutional IdP, and land in the app with a session and local user record
2. **Google OAuth login works end-to-end** — MQ students with @students.mq.edu.au Google accounts can click "Login with Google" and auto-provision into the app
3. **JIT provisioning configured** — first-time users via both AAF and Google auto-create accounts without pre-invitation
4. **AAF attributes mapped to app roles** — eduperson_affiliation flows through to distinguish instructors from students
5. **B2C fallback documented** — if B2B SSO proves unworkable, a documented migration path to Stytch B2C (magic links + Google OAuth, no AAF) exists
6. **AAF test federation established** — test credentials registered for development and CI, so production credentials aren't needed for testing

## Acceptance Criteria

### aaf-oidc-auth-188-189.AC1: AAF OIDC login works end-to-end
- **aaf-oidc-auth-188-189.AC1.1 Success:** MQ staff user clicks "Login with AAF", authenticates at AAF, returns to app with active session and local user record created
- **aaf-oidc-auth-188-189.AC1.2 Success:** Returning AAF user logs in again; existing local user record is updated (last_login), not duplicated
- **aaf-oidc-auth-188-189.AC1.3 Failure:** AAF authentication failure (cancelled, denied) returns user to login page with error message
- **aaf-oidc-auth-188-189.AC1.4 Failure:** Invalid/expired SSO token returns error, does not create session
- **aaf-oidc-auth-188-189.AC1.5 Edge:** SSO callback with missing token parameter shows error, not a crash

### aaf-oidc-auth-188-189.AC2: Google OAuth login works end-to-end
- **aaf-oidc-auth-188-189.AC2.1 Success:** Student with @students.mq.edu.au Google account clicks "Login with Google", authenticates, auto-provisions into app
- **aaf-oidc-auth-188-189.AC2.2 Success:** "Login with Google" button appears on login page below AAF button
- **aaf-oidc-auth-188-189.AC2.3 Success:** OAuth callback handler works identically for Google and GitHub providers
- **aaf-oidc-auth-188-189.AC2.4 Failure:** Google OAuth error redirects to login page with error message

### aaf-oidc-auth-188-189.AC3: JIT provisioning
- **aaf-oidc-auth-188-189.AC3.1 Success:** First-time AAF user auto-creates local account without pre-invitation
- **aaf-oidc-auth-188-189.AC3.2 Success:** First-time Google OAuth user with @students.mq.edu.au auto-creates local account
- **aaf-oidc-auth-188-189.AC3.3 Edge:** JIT provisioning bootstrap — at least one member with verified @students.mq.edu.au email exists before student JIT works

### aaf-oidc-auth-188-189.AC4: AAF attributes mapped to app roles
- **aaf-oidc-auth-188-189.AC4.1 Success:** AAF user with `eduperson_affiliation` containing "staff" gets `instructor` role and passes `is_privileged_user()` check
- **aaf-oidc-auth-188-189.AC4.2 Success:** AAF user with `eduperson_affiliation` containing "faculty" gets `instructor` role
- **aaf-oidc-auth-188-189.AC4.3 Success:** AAF user with `eduperson_affiliation` containing "student" gets no special roles, fails `is_privileged_user()` check
- **aaf-oidc-auth-188-189.AC4.4 Edge:** AAF user with missing `eduperson_affiliation` (attribute not released by institution) gets no special roles (fail-open to unprivileged)
- **aaf-oidc-auth-188-189.AC4.5 Edge:** AAF user with multiple affiliations (e.g. "staff" and "student") gets `instructor` role (highest privilege wins)
- **aaf-oidc-auth-188-189.AC4.6 Success:** `trusted_metadata` from Stytch response is read and passed through in `AuthResult`

### aaf-oidc-auth-188-189.AC5: B2C fallback documented
- **aaf-oidc-auth-188-189.AC5.1 Success:** `docs/b2c-fallback.md` exists with migration guide
- **aaf-oidc-auth-188-189.AC5.2 Success:** Document covers: what changes, what stays, what's lost, what's gained, estimated effort

### aaf-oidc-auth-188-189.AC6: AAF test federation established
- **aaf-oidc-auth-188-189.AC6.1 Success:** Test OIDC client registered at `manager.test.aaf.edu.au` with valid credentials
- **aaf-oidc-auth-188-189.AC6.2 Success:** Test user exists in AAF test federation (VHO or Rapid IdP)
- **aaf-oidc-auth-188-189.AC6.3 Success:** Stytch OIDC connection works against test federation endpoints

### aaf-oidc-auth-188-189.AC7: Magic link domain enforcement
- **aaf-oidc-auth-188-189.AC7.1 Success:** Magic link with @mq.edu.au email sends successfully
- **aaf-oidc-auth-188-189.AC7.2 Success:** Magic link with @students.mq.edu.au email sends successfully
- **aaf-oidc-auth-188-189.AC7.3 Failure:** Magic link with @gmail.com (or any non-MQ domain) shows error message, does not send
- **aaf-oidc-auth-188-189.AC7.4 Success:** Error message tells user to use their Macquarie University email

## Glossary

- **AAF (Australian Access Federation)**: Australia's national federated identity service for higher education. Member institutions allow their staff and students to authenticate at third-party services using their institutional credentials without creating separate accounts.
- **OIDC (OpenID Connect)**: An identity layer built on top of OAuth 2.0. The authenticating party (here, AAF) issues a signed token containing claims about the user. Stytch acts as the OIDC relying party, exchanging an authorization code for a token and validating it.
- **SSO (Single Sign-On)**: A session/authentication scheme that lets a user log in once through an identity provider and access multiple services without re-authenticating.
- **IdP (Identity Provider)**: The system that authenticates the user and issues identity assertions. In this document: AAF Central acts as IdP, which in turn federates to MQ's own institutional IdP (MQ OneID).
- **Stytch B2B / B2C**: Stytch offers two client modes. B2B organises users into Organisations and supports custom OIDC connections (required for AAF). B2C only supports predefined OAuth providers — it cannot connect to AAF.
- **`trusted_metadata`**: A Stytch member field that stores arbitrary key-value data, here used to carry AAF identity attributes (like `eduperson_affiliation`) extracted from the OIDC token via dashboard-configured attribute mappings.
- **`eduperson_affiliation`**: A standard attribute in the eduPerson schema used in academic identity federations. Values (e.g. `staff`, `faculty`, `student`) describe a person's relationship to their home institution.
- **`schac_home_organization`**: A SCHAC attribute that carries the user's home institution domain (e.g. `mq.edu.au`). Included in scope requests for future use.
- **JIT provisioning**: Automatic creation of a local user account on first login, without pre-invitation. Stytch's `email_jit_provisioning` setting controls which email domains are eligible.
- **VHO / Rapid IdP**: Test infrastructure provided by AAF. Virtual Home Organisation and Rapid IdP allow developers to simulate AAF logins without real institutional credentials.
- **AAF test federation**: AAF's staging environment (`central.test.aaf.edu.au`), mirroring production. Used for development and CI.
- **`AuthClientProtocol`**: Internal Python interface (`auth/protocol.py`) that all authentication clients implement. Allows swapping between real Stytch client and mock for testing.
- **`AuthResult`**: Internal dataclass returned by every authentication path. Extended in this work to carry `trusted_metadata`.
- **`derive_roles_from_metadata()`**: New function that reads `eduperson_affiliation` from `trusted_metadata` and returns app roles. Pure function, independently testable.
- **SkipDS**: AAF mechanism to bypass the institution-selection page during SSO by pre-specifying the user's home institution (`entityID` parameter).
- **Magic link**: Passwordless authentication where Stytch emails a one-time login URL. This work adds domain enforcement to restrict to MQ email addresses.

## Architecture

### Login Hierarchy

| Priority | Method | Audience | Provider String |
|----------|--------|----------|-----------------|
| Primary | AAF OIDC (SSO) | All MQ staff + students | Stytch SSO connection |
| Backstop | Google OAuth | Students who can't AAF | `"google"` |
| Back-backstop | Magic Link | Edge cases | N/A (email-based) |
| Dev/admin | GitHub OAuth | Brian | `"github"` (unchanged) |

AAF is the prominent login button. Google is secondary. Magic link is collapsed/tertiary. GitHub is small/dev-only.

### Auth Flow

```
Login Page
├── Login with AAF (primary, prominent)
│   └── Stytch SSO start (connection_id)
│       → AAF Central /oidc/authorize
│       → MQ OneID / institution IdP
│       → Stytch callback (code exchange)
│       → /auth/sso/callback
│           → authenticate_sso() → AuthResult with trusted_metadata
│           → derive_roles_from_metadata() → instructor/student
│           → upsert_user_on_login()
│
├── Login with Google (backstop)
│   └── Stytch OAuth start (provider="google")
│       → Google sign-in
│       → Stytch callback
│       → /auth/oauth/callback
│           → authenticate_oauth() → AuthResult
│           → upsert_user_on_login()
│
├── Magic Link (back-backstop, domain-restricted)
│   └── Validate email domain (@mq.edu.au, @students.mq.edu.au)
│       → send_magic_link()
│       → /auth/callback
│           → authenticate_magic_link() → AuthResult
│           → upsert_user_on_login()
│
└── Login with GitHub (dev, unchanged)
```

### Key Design Decisions

**B2B, not B2C.** Stytch B2C cannot connect to custom OIDC providers — only predefined OAuth providers. AAF requires generic OIDC, which is B2B-only. The app continues using `B2BClient` with a single Stytch organisation.

**App-side role mapping.** AAF attributes flow into `trusted_metadata` via Stytch's OIDC attribute mapping. The app reads `eduperson_affiliation` from `trusted_metadata` in the SSO callback and derives roles. This is testable and doesn't depend on Stytch dashboard RBAC configuration (which doesn't support OIDC implicit role assignment anyway).

**Diagnostic-first.** The OIDC connection already exists in Stytch but fails for unknown reasons. Phase 1 diagnoses the failure before writing code, since the fix may be purely configuration.

### Contracts

```python
# Extended AuthResult — auth/models.py
@dataclass
class AuthResult:
    success: bool
    session_token: str | None = None
    session_jwt: str | None = None
    member_id: str | None = None
    organization_id: str | None = None
    email: str | None = None
    name: str | None = None
    roles: list[str] = field(default_factory=list)
    trusted_metadata: dict[str, Any] | None = None  # NEW
    error: str | None = None

# New role mapping — auth/__init__.py
_STAFF_AFFILIATIONS: frozenset[str] = frozenset({"staff", "faculty"})

def derive_roles_from_metadata(
    trusted_metadata: dict[str, Any] | None,
) -> list[str]:
    """Map IdP attributes to app roles.

    Reads eduperson_affiliation from trusted_metadata.
    staff/faculty → ["instructor"]. Otherwise → [].
    """
    ...
```

### Stytch OIDC Connection Configuration

For AAF Central (production):

| Field | Value |
|-------|-------|
| `identity_provider` | `"generic"` |
| `issuer` | `https://central.aaf.edu.au` |
| `authorization_url` | Auto-discovered from `.well-known/openid-configuration` |
| `token_url` | Auto-discovered |
| `userinfo_url` | Auto-discovered |
| `jwks_url` | Auto-discovered |
| `client_id` | From AAF registration |
| `client_secret` | From AAF registration |
| `custom_scopes` | `openid profile email eduperson_affiliation schac_home_organization` |

The `redirect_url` generated by Stytch must be registered with AAF as the redirect URI.

For test federation: same structure, replace `central.aaf.edu.au` with `central.test.aaf.edu.au`.

## Existing Patterns

Investigation found the auth system follows a clean protocol-based pattern:

- `AuthClientProtocol` in `auth/protocol.py` — all auth clients implement this interface
- `StytchB2BClient` in `auth/client.py` — wraps Stytch SDK, implements protocol
- `MockAuthClient` in `auth/mock.py` — test double, implements protocol
- `get_auth_client()` in `auth/factory.py` — returns real or mock based on config

This design follows the same pattern:
- `AuthResult` extended with `trusted_metadata` field (existing dataclass)
- `derive_roles_from_metadata()` added to `auth/__init__.py` alongside `is_privileged_user()`
- OAuth UI follows existing `_build_github_oauth_section()` pattern for Google
- Mock client extended with `trusted_metadata` support for test users

The OAuth infrastructure is already provider-agnostic: `get_oauth_start_url(provider, ...)` accepts any provider string. Adding Google requires only a UI button change.

**Divergence:** Magic link domain enforcement is new. Currently `send_magic_link()` accepts any email. Validation added at the login page level (UI) with Stytch's `email_allowed_domains` as server-side backstop.

## Implementation Phases

**Phase 0 (prerequisite, human/manual):** Register AAF test federation OIDC client at `manager.test.aaf.edu.au`, create test user in VHO or Rapid IdP, record credentials. This is dashboard work, not code.

<!-- START_PHASE_1 -->
### Phase 1: AAF OIDC Diagnostic & Fix
**Goal:** Get the existing AAF OIDC connection in Stytch working against the test federation.

**Components:**
- Stytch dashboard — verify OIDC connection status, endpoint URLs, redirect URI, credentials
- AAF test federation — verify client registration, redirect URI match
- No code changes expected (configuration fix)

**Dependencies:** Phase 0 (test federation credentials exist)

**Done when:** Clicking "Login with AAF" in dev environment redirects to AAF test federation, authenticates a test user, and returns to `/auth/sso/callback` with a valid token that creates a session. Manual verification.

**Abort condition:** If diagnosis reveals a fundamental incompatibility between Stytch's generic OIDC handler and AAF's implementation (not a configuration issue), stop and return to brainstorming. Do not proceed to Phase 2. The remaining phases depend on a working OIDC connection.
<!-- END_PHASE_1 -->

<!-- START_PHASE_2 -->
### Phase 2: Trusted Metadata Pipeline
**Goal:** Extend the auth flow to read AAF attributes from Stytch responses and map them to app roles.

**Components:**
- `AuthResult` in `src/promptgrimoire/auth/models.py` — add `trusted_metadata: dict[str, Any] | None` field
- `StytchB2BClient.authenticate_sso()` in `src/promptgrimoire/auth/client.py` — read `response.member.trusted_metadata`
- `derive_roles_from_metadata()` in `src/promptgrimoire/auth/__init__.py` — map `eduperson_affiliation` to roles
- `MockAuthClient` in `src/promptgrimoire/auth/mock.py` — return `trusted_metadata` for test users
- SSO callback in `src/promptgrimoire/pages/auth.py` — call `derive_roles_from_metadata()` and merge roles
- Stytch OIDC attribute mapping (dashboard) — configure `eduperson_affiliation` and `schac_home_organization` to flow into `trusted_metadata`

**Dependencies:** Phase 1 (working AAF connection to test against)

**Done when:** SSO login with AAF test user returns `trusted_metadata` containing `eduperson_affiliation`. Staff/faculty affiliation results in `instructor` privilege. Student affiliation does not. Tests for `derive_roles_from_metadata()` pass.
<!-- END_PHASE_2 -->

<!-- START_PHASE_3 -->
### Phase 3: Google OAuth
**Goal:** Add Google OAuth as a backstop login method.

**Components:**
- `_build_google_oauth_section()` in `src/promptgrimoire/pages/auth.py` — new function, copy of GitHub pattern with `provider="google"`
- Login page layout in `src/promptgrimoire/pages/auth.py` — reorder buttons (AAF primary, Google secondary, magic link tertiary, GitHub small)
- OAuth callback log message — genericise from "GitHub" to provider-agnostic
- Stytch dashboard — enable Google OAuth provider, configure Google Cloud OAuth credentials
- JIT provisioning (dashboard) — set `email_jit_provisioning: "RESTRICTED"`, add `students.mq.edu.au` and `mq.edu.au` to `email_allowed_domains`

**Dependencies:** None (independent of Phase 1-2, but ordered after for focus)

**Done when:** "Login with Google" button appears on login page. Clicking it redirects to Google sign-in. After authenticating with an @students.mq.edu.au account, user is provisioned and lands in the app with a session. Tests verify button rendering and OAuth URL construction.
<!-- END_PHASE_3 -->

<!-- START_PHASE_4 -->
### Phase 4: Magic Link Domain Enforcement
**Goal:** Restrict magic link login to MQ email domains.

**Components:**
- Email validation in `src/promptgrimoire/pages/auth.py` — validate email domain before calling `send_magic_link()`
- Allowed domains list — initially hardcoded in the validation logic as `{"mq.edu.au", "students.mq.edu.au"}` (or configurable via settings)
- User-facing error message when domain is rejected
- `MockAuthClient` — no change needed (mock accepts any email for test flexibility)

**Dependencies:** None (independent)

**Done when:** Magic link form rejects non-MQ email addresses with a clear error message. MQ emails are accepted. Tests verify domain validation logic.
<!-- END_PHASE_4 -->

<!-- START_PHASE_5 -->
### Phase 5: Production AAF Cutover
**Goal:** Switch from test federation to production AAF credentials.

**Components:**
- Stytch dashboard — update OIDC connection issuer to `https://central.aaf.edu.au`, update client_id and client_secret to production credentials
- AAF production federation — verify redirect URI is registered
- Environment config — update `STYTCH__SSO_CONNECTION_ID` if connection was recreated

**Dependencies:** Phase 1-2 (test federation flow proven)

**Done when:** AAF login works with production MQ credentials. Staff member can authenticate and lands in app with correct role.
<!-- END_PHASE_5 -->

<!-- START_PHASE_6 -->
### Phase 6: B2C Fallback Documentation
**Goal:** Document the migration path to Stytch B2C if B2B SSO proves unworkable.

**Components:**
- New document `docs/b2c-fallback.md` — migration guide covering:
  - What changes (`B2BClient` → `Client`, remove `organization_id`, update protocol)
  - What stays (all business logic, database, ACLs)
  - What's lost (AAF OIDC, organisation-scoped auth)
  - What's gained (simpler model, no org bootstrapping)
  - Estimated effort (~50-100 lines, 2-4 hours)

**Dependencies:** None (can be written anytime)

**Done when:** `docs/b2c-fallback.md` exists with sufficient detail for a developer to execute the migration.
<!-- END_PHASE_6 -->

## Additional Considerations

**AAF credential security:** AAF client_secret is shown once during registration and cannot be recovered. Store in environment variables, never in code or config files. Use `SecretStr` (already in `StytchConfig` for the Stytch secret).

**AAF propagation delay:** Production AAF registrations take ~2 hours to propagate. Test federation activates immediately. Plan accordingly during production cutover.

**Google OAuth step-up auth:** Google doesn't always prove email ownership authoritatively for all account types. Some students may see a one-time email verification (magic link or OTP) on first Google OAuth login. This is Stytch's security measure and cannot be configured away.

**JIT provisioning bootstrap:** Email domain JIT provisioning requires at least one existing member with a verified email from each allowed domain. Bootstrap by creating one member manually (e.g., via magic link) with `@students.mq.edu.au` before Google OAuth JIT works for students.

**SkipDS (skip discovery service):** AAF's OIDC flow normally shows an institution selection page. This can be bypassed by passing `entityID` as a parameter to the authorization URL. Whether this is passable through Stytch's SSO start flow is unknown — investigate during Phase 1 diagnostic. If not possible, users will see the AAF institution picker (acceptable UX, not critical).
