# Mega UAT: CSS Highlight API + Copy Protection + Pydantic-Settings

**Date:** 2026-02-14
**Branch:** main (post-merge of PRs #155, #157, #158)

## Prerequisites

- PostgreSQL running
- `.env` configured with double-underscore var names (`DATABASE__URL`, `LLM__API_KEY`, etc.)
- `uv run alembic upgrade head`
- `uv run seed-data`
- Chrome 105+ or Edge 105+
- Two browser sessions available (different accounts or profiles)
- Roles available: instructor/admin and student

---

## A. Pydantic-Settings (#130)

### A1. Environment variable migration

| # | Action | Expected |
|---|--------|----------|
| 1 | Rename `.env` vars to double-underscore format per `.env.example` | App starts without warnings |
| 2 | Start the app: `uv run python -m promptgrimoire` | Boots cleanly, no `load_dotenv` deprecation, no missing var errors |
| 3 | Verify DB connection works (navigate to `/annotation`) | Page loads, workspace creation works |
| 4 | Set an invalid type (e.g. `APP__PORT=notanumber`) and restart | App fails fast with clear `ValidationError` |
| 5 | Unset `APP__PORT` and restart | App starts with default port (8080) |

---

## B. CSS Custom Highlight API (#158)

### B1. Browser feature gate

| # | Action | Expected |
|---|--------|----------|
| 1 | Open Chrome 105+ to `/login` | Login page renders normally, no overlay |
| 2 | DevTools console: `delete CSS.highlights; window.__checkBrowserGate()` | Full-page overlay: "Your browser does not support..." |
| 3 | Read overlay text | Lists Chrome 105+, Firefox 140+, Safari 17.2+, Edge 105+ |
| 4 | Verify login UI is fully obscured | Email input and button not accessible |
| 5 | Click "Go Home" link | Navigates to `/` |

### B2. Highlight visual quality

| # | Action | Expected |
|---|--------|----------|
| 1 | Log in, navigate to `/annotation`, create workspace | Page loads |
| 2 | Paste multi-paragraph text, confirm content type | Document renders clean â€” no `<span class="char">` artifacts |
| 3 | Select text, click a tag button | Coloured highlight background appears, text readable |
| 4 | Select different text, apply different tag | Visually distinct colour |
| 5 | Select overlapping text, apply third tag | Overlapping region shows layered colours |
| 6 | DevTools: `Array.from(CSS.highlights.keys())` | Returns highlight names, no char-span DOM elements |
| 7 | Assess overall visual quality | Backgrounds visible but don't obscure text, colours distinguishable, no boundary artefacts |

### B3. Scroll-sync and card interaction

| # | Action | Expected |
|---|--------|----------|
| 1 | Long document with 3-4 highlights at different positions | Cards appear in sidebar |
| 2 | Scroll slowly top to bottom | Cards smoothly track positions, no jitter |
| 3 | Scroll rapidly | Cards reposition without significant delay |
| 4 | Hover over annotation card | Corresponding highlight gets temporary emphasis |
| 5 | Move mouse away | Hover highlight disappears cleanly |
| 6 | Click go-to button on off-screen card | Document scrolls to highlight, brief bright flash (~800ms throb) |
| 7 | Assess throb animation | Noticeable but not jarring, fades cleanly |

### B4. Remote presence (two browser windows)

| # | Action | Expected |
|---|--------|----------|
| 1 | Window A + B: log in as different users, same workspace | Both show annotation page |
| 2 | Window A: click within document text | Window B: coloured cursor line with A's name label |
| 3 | Assess cursor appearance | Thin, coloured, clearly visible, name readable |
| 4 | Window A: drag-select text | Window B: coloured selection highlight (distinct from annotations) |
| 5 | Window A: verify own view | No remote cursor/selection for self |
| 6 | Close Window A | Window B: A's cursor/selection disappears within seconds |

### B5. Full annotation workflow

| # | Action | Expected |
|---|--------|----------|
| 1 | Create workspace, paste HTML with paragraphs + list + heading | Content renders |
| 2 | Create 3 highlights across different elements | All visible in CSS.highlights |
| 3 | Add annotation comment to at least one highlight | Comment appears in sidebar card |
| 4 | Verify sidebar cards show correct content | Quoted text matches highlighted region |
| 5 | Scroll and verify card tracking | Cards follow their highlights |
| 6 | Export to PDF | Highlights and margin notes render correctly |

---

## C. Copy Protection (#103)

### C1. Client-side protection (as student)

| # | Action | Expected |
|---|--------|----------|
| 1 | Navigate to annotation page for protected activity | Lock icon chip (amber, "Protected") visible in header |
| 2 | Hover lock chip | Tooltip: "Copy protection is enabled for this activity" |
| 3 | Tab 1: select text, Ctrl+C | Blocked; toast "Copying is disabled for this activity." |
| 4 | Rapidly press Ctrl+C 5 times | Only one toast visible (deduplication) |
| 5 | Tab 1: select text, Ctrl+X | Blocked; toast shown |
| 6 | Tab 1: right-click on document | Context menu blocked; toast shown |
| 7 | Tab 1: drag selected text | Drag blocked; toast shown |
| 8 | Tab 2 (organise): select text, Ctrl+C | Blocked; toast shown |
| 9 | Tab 3 (respond): select text on reference card, Ctrl+C | Blocked; toast shown |
| 10 | Tab 3: type in Milkdown editor, select own text, Ctrl+C | Copy WORKS (own writing not protected) |
| 11 | Tab 3: Ctrl+V into Milkdown editor | Blocked; toast shown |
| 12 | Tab 1: select text, use highlighting tool | Selection and highlighting work normally |
| 13 | As instructor, same activity | No lock chip; copy/paste/drag all work |
| 14 | Navigate to loose workspace | No lock chip; no protection |

### C2. Print suppression (as student)

| # | Action | Expected |
|---|--------|----------|
| 1 | Protected activity: Ctrl+P | Print dialog blocked; toast shown |
| 2 | File > Print | Print preview shows "Printing is disabled for this activity." |
| 3 | As instructor, Ctrl+P same activity | Print dialog opens normally |
| 4 | Instructor print preview | Normal page content shown |

### C3. Instructor UI controls

| # | Action | Expected |
|---|--------|----------|
| 1 | As instructor, course detail page | Gear icon in header |
| 2 | Click gear icon | Course settings dialog opens |
| 3 | Verify "Default copy protection" toggle | Reflects current state |
| 4 | Toggle, click Save | "Course settings saved" notification |
| 5 | Reload, reopen dialog | Toggle state persisted |
| 6 | Find activity row | Tune icon visible |
| 7 | Click tune icon | Activity settings dialog opens |
| 8 | Verify "Copy protection" select | 3 options: Inherit from course / On / Off |
| 9 | New activity default | Shows "Inherit from course" |
| 10 | Change to "On", Save | "Activity settings saved" notification |
| 11 | Reload, reopen | Shows "On" (persisted) |
| 12 | Change to "Inherit from course", Save | Notification shown |

### C4. Full inheritance chain

| # | Action | Expected |
|---|--------|----------|
| 1 | Instructor: set course default OFF | Saved |
| 2 | Reset activity to "Inherit from course" | Saved |
| 3 | Student: visit annotation page | No lock chip; copy works |
| 4 | Instructor: set course default ON | Saved |
| 5 | Student: reload same page | Lock chip appears; copy blocked |
| 6 | Instructor: set activity to explicit "Off" | Saved |
| 7 | Student: reload | No lock chip (explicit override wins) |
| 8 | Instructor: set course default OFF | Saved |
| 9 | Instructor: reset activity to "Inherit" | Saved |
| 10 | Student: reload | No protection (inherits course default=False) |

### C5. Role-based bypass

| # | Action | Expected |
|---|--------|----------|
| 1 | Set activity to explicit On | Saved |
| 2 | Admin visits annotation page | No lock chip; everything works |
| 3 | Instructor visits same page | No lock chip; everything works |
| 4 | Student visits same page | Lock chip; copy blocked |
| 5 | Tutor visits same page | Lock chip; copy blocked (tutors not privileged) |
