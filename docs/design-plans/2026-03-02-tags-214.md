# Empty Template Tag Management Design

**GitHub Issue:** #214

## Summary

When an instructor creates an activity, the system provisions an empty template workspace. That workspace is meant to be configured — tags, tag groups, and imported annotations — before students arrive. Currently, the annotation page's tag toolbar only renders when the workspace already contains documents. On an empty template, the page falls into the upload branch and renders no toolbar at all, leaving tag management entirely unreachable until the instructor uploads content first.

This change adds the tag toolbar to the empty-document upload branch of the annotation page. The toolbar renders identically to how it appears in the document-present case — tag buttons, quick-create, and the "Manage Tags" button — using the same callbacks already wired up by the page's initialisation code. Because cloning already copies all tags and tag groups from the template workspace to each student workspace when they start the activity, no changes to the cloning or storage logic are needed. The fix is localised to a single conditional branch in the annotation page.

## Definition of Done
1. When an instructor clicks "Create Template" on an activity with an empty template workspace, the annotation page loads successfully and provides access to tag management (tag groups, tags, import from other activities)
2. Tags configured on the empty template are correctly snapshot-copied when students later clone the activity
3. The annotation page remains fully functional for workspaces that already have content (no regressions)

## Acceptance Criteria

### tags-214.AC1: Tag management accessible on empty template workspace
- **tags-214.AC1.1 Success:** Annotation page loads without error for an empty template workspace (zero WorkspaceDocument rows) and displays the tag toolbar
- **tags-214.AC1.2 Success:** "Manage Tags" button in toolbar opens the tag management dialog; tag groups and tags can be created, edited, and deleted
- **tags-214.AC1.3 Success:** Tag import from another activity works from the management dialog on an empty template
- **tags-214.AC1.4 Success:** Toolbar refreshes correctly after tag mutations (create, delete, rename) without page reload

### tags-214.AC2: Tags on empty template clone correctly
- **tags-214.AC2.1 Success:** Tags and tag groups configured on an empty template are snapshot-copied to a student workspace when the student clones the activity

### tags-214.AC3: No regressions
- **tags-214.AC3.1 Success:** Annotation page with existing documents renders identically to before (tag toolbar, highlight menu, document content all present)

## Glossary

- **Activity**: A unit of coursework defined by an instructor. Each activity has one template workspace and generates one student workspace per student who starts it.
- **Template workspace**: The instructor-owned workspace attached to an activity. Tags configured here are copied to every student workspace when students begin the activity.
- **Snapshot-copy / clone**: When a student starts an activity, the system copies the template's tag groups, tags, and CRDT state into a fresh workspace. This is a one-time copy; subsequent changes to the template do not propagate.
- **WorkspaceDocument**: A database row representing a single uploaded document within a workspace. An empty template has zero WorkspaceDocument rows.
- **Tag / TagGroup**: Annotation categories scoped to a workspace. Tags belong to groups; groups are display-level containers. Both are stored per-workspace in the database.
- **Tag toolbar**: A UI bar on the annotation page containing buttons for each tag, a quick-create button, and a "Manage Tags" button. Currently only rendered when documents are present.
- **`_build_tab_panels()`**: The function in `workspace.py` that constructs the annotation page's three-tab layout and branches on workspace state (documents present, empty with upload permission, empty read-only).
- **`_rebuild_toolbar()`**: A callback that clears and re-renders the tag toolbar after a mutation (create, rename, delete, import). Requires `state.toolbar_container` to be set.
- **`state.toolbar_container`**: A reference stored on the page state object pointing to the NiceGUI element that wraps the tag toolbar. Must be assigned for `_rebuild_toolbar()` to target the correct element.
- **`can_annotate` / `can_upload`**: Boolean flags on the page state object derived from the user's workspace permission level. `can_upload` (editor/owner) is a strict subset of `can_annotate` (peer/editor/owner). The empty-document branch is gated on `can_upload`, so peers never reach it.

## Architecture

The annotation page (`pages/annotation/workspace.py`) renders a three-tab container via `_build_tab_panels()`. When the Annotate tab loads, it branches on whether the workspace has documents:

- **Documents exist** (line 485): calls `_render_document_with_highlights()`, which builds the tag toolbar (`_build_tag_toolbar()` in `css.py:493`) and the floating highlight menu. Tag management is accessible via "Manage Tags" button in the toolbar.
- **No documents, can upload** (line 507): calls `_render_add_content_form()`. No tag toolbar is rendered. Tag management is unreachable.
- **No documents, read-only** (line 511): shows "no documents yet" label. Correct as-is.

The fix adds the tag toolbar to the empty-document-with-upload branch. The toolbar renders identically to the document-present case: tag buttons (inert without a document to annotate), quick-create button, and "Manage Tags" button. The `on_add_tag` and `on_manage_tags` callbacks are already created in `_create_tag_callbacks()` (line 350) and passed to `_build_tab_panels()` — they just need to be wired to UI elements in the empty branch.

`state.toolbar_container` must be set so that `_rebuild_toolbar()` (line 362) can clear and rebuild after tag mutations (create, edit, delete, import).

No changes to tag storage, cloning (`clone_workspace_from_activity` in `workspaces.py:591`), import (`import_tags_from_activity` in `db/tags.py:428`), or the read-only branch.

## Existing Patterns

The tag toolbar rendering in `_render_document_with_highlights()` (`document.py:248-255`) is the pattern to follow:

```python
if state.can_annotate:
    state.toolbar_container = _build_tag_toolbar(
        state.tag_info_list or [],
        handle_tag_click,
        on_add_click=on_add_click,
        on_manage_click=on_manage_click,
        footer=footer,
    )
```

The empty-document branch replicates this pattern. The `handle_tag_click` closure follows the same structure as `document.py:244`. Clicking a tag button calls `_add_highlight`, which guards against missing documents (`highlights.py:204-207`) and returns early with a "No document" notification. This guard also protects the `_tag_click` closure inside `_rebuild_toolbar()` (workspace.py:367-368).

**Permission model:** The empty-document branch is gated on `state.can_upload` (editor/owner only), which is a strict subset of `state.can_annotate` (peer/editor/owner). Peers hit the read-only branch (line 511) instead. No additional permission check is needed for the toolbar in the empty branch.

## Implementation Phases

<!-- START_PHASE_1 -->
### Phase 1: Tag toolbar on empty template workspaces

**Goal:** Render the tag toolbar in the empty-document branch of `_build_tab_panels()` so instructors can access tag management before uploading content.

**Components:**
- `src/promptgrimoire/pages/annotation/workspace.py` — add toolbar rendering in the `elif state.can_upload:` branch (line 507)

**Dependencies:** None

**Done when:**
- Annotation page loads for an empty template workspace and displays the tag toolbar with "Manage Tags" button
- Tag groups and tags can be created, edited, deleted, and imported via the management dialog on an empty workspace
- `_rebuild_toolbar()` works after tag mutations (toolbar refreshes correctly)
- Tags configured on empty template are cloned correctly when a student starts the activity
- Annotation page with existing documents continues to work identically (no regressions)
- Tests pass verifying the above: `tags-214.AC1.1` through `tags-214.AC1.4`, `tags-214.AC2.1`, `tags-214.AC3.1`
<!-- END_PHASE_1 -->

## Additional Considerations

**Transition after content upload:** When an instructor uploads content to a previously-empty template, the page reloads and enters the `if documents:` branch. The toolbar is rebuilt inside `_render_document_with_highlights()` as normal. Tags already configured persist in the database and load via `workspace_tags()`. No special migration or handoff logic needed.
