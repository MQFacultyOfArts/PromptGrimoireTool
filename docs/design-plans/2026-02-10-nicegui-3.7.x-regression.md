# NiceGUI 3.7.x Regression: Char Span Destruction

**Date**: 2026-02-10
**Branch**: annotation-guards (cherry-picked to 134-lua-highlight, main)
**Status**: Pinned to 3.6.1, upstream issue filed

## Summary

NiceGUI 3.7.0 introduces a regression where server-side element updates trigger a Vue destroy+recreate cycle that wipes client-side JavaScript DOM modifications. This breaks the annotation page's character-level text selection, which relies on JS-injected `<span data-char-index="N">` elements wrapping each text character inside `ui.html()`.

## Symptoms

1. After page refresh, text selection fails — `charSpanCount` drops from ~27,000 to 0
2. Browser selects entire page above cursor instead of the targeted range
3. Vue error: `TypeError: Cannot read properties of undefined (reading 'props')` in `input.js:31` during `beforeUnmount`
4. Keyboard shortcuts (1-9 for tags) report "No selection"

## Root Cause

### The destroy+recreate cycle

`nicegui.js` update handler (~line 481) detects changed event listener IDs and performs:

```javascript
// 1. Delete element from Vue reactive state
delete this.elements[id];
eventListenersChanged = true;

// 2. Wait for Vue to process deletion (unmount old DOM)
await this.$nextTick();

// 3. Re-add element (Vue creates fresh DOM from server state)
this.elements[id] = element;
```

The fresh DOM element has the original HTML from the server — no char spans. In 3.6.1 this cycle either didn't trigger or triggered less aggressively. In 3.7.x it fires on routine updates (visibility toggles, annotation card refreshes).

### The beforeUnmount crash (PR #5652)

NiceGUI 3.7.0 added a `beforeUnmount` hook to `input.js` to persist input values across unmount/remount cycles (PR [#5652](https://github.com/zauberzeug/nicegui/pull/5652)):

```javascript
beforeUnmount() {
    mounted_app.elements[this.$props.id.slice(1)].props.value = this.inputValue;
}
```

This crashes because `mounted_app.elements[id]` is already `undefined` — the element was deleted from the registry (line 486 of `nicegui.js`) before Vue's unmount lifecycle hook fires.

### Likely contributing changes in 3.7.0

- **#5673**: "implicit handshake and fix `on_connect` called before page is ready" — changed websocket initialization timing
- **#5652**: "input elements not being updated when re-opening a `ui.dialog`" — added the crashing `beforeUnmount` hooks

## Investigation Timeline

1. User reported selection broken across all branches (annotation-guards, 134-lua-highlight, main, 94-hierarchy-placement)
2. Diagnostic logging added to `processSelection()` JS — confirmed `charSpanCount` drops to 0 after server updates
3. `git log -- uv.lock` revealed `05fa672 deps: upgrade nicegui 3.6.1 → 3.7.1` (Feb 7) present in all affected branches
4. Pinned `nicegui==3.6.1` in `pyproject.toml` — selection immediately works
5. Confirmed with minimal reproduction script (see below)

## Minimal Reproduction

File: `/tmp/nicegui_repro/repro.py`

```python
"""Minimal repro: NiceGUI 3.7.x destroys client-side DOM mods.

Text should have alternating pink/blue character backgrounds.
Click the button to trigger a server-side element update.
In 3.7.x the coloring disappears. In 3.6.1 it stays.

Usage (no install needed, uv creates a temp env):
    uv run --with nicegui==3.6.1 python repro.py  # works
    uv run --with nicegui==3.7.1 python repro.py  # broken
"""

import nicegui
from nicegui import ui


@ui.page("/")
def index():
    ui.label(f"NiceGUI {nicegui.__version__}").classes("text-h5")
    ui.label("Text below has alternating pink/blue chars.")
    ui.label("Click the button. In 3.7.x the color vanishes.")

    ui.html(
        "<p>Hello world sample text for char spans</p>",
        sanitize=False,
    ).props('id="target"')

    # Inject styled spans wrapping each character
    ui.run_javascript("""
        const el = document.getElementById('target');
        if (!el) return;
        let idx = 0;
        function wrap(node) {
            if (node.nodeType === Node.TEXT_NODE) {
                const frag = document.createDocumentFragment();
                for (const ch of node.textContent) {
                    const s = document.createElement('span');
                    s.dataset.charIndex = idx;
                    s.style.backgroundColor =
                        idx % 2 === 0 ? '#ffcccc' : '#ccccff';
                    s.textContent = ch;
                    idx++;
                    frag.appendChild(s);
                }
                node.parentNode.replaceChild(frag, node);
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                Array.from(node.childNodes).forEach(wrap);
            }
        }
        Array.from(el.childNodes).forEach(wrap);
        console.log('[REPRO] Injected ' + idx + ' spans');
    """)

    # Button triggers a server-side element update
    target = ui.label("I am visible").classes("text-lg")

    def on_click() -> None:
        target.set_visibility(not target.visible)

    ui.button(
        "Toggle (triggers server update)",
        on_click=on_click,
    )


ui.run(port=8090)
```

## Fix Applied

**Commit**: `4160c54` (annotation-guards), cherry-picked to 134-lua-highlight

```toml
# pyproject.toml
"nicegui==3.6.1",  # pinned: 3.7.x breaks char span injection
```

## Upstream Issues

- **NiceGUI**: [#5748](https://github.com/zauberzeug/nicegui/issues/5748) (closed — filed without template, to be re-filed by user with screenshots)
- **Internal**: [#138](https://github.com/MQFacultyOfArts/PromptGrimoireTool/issues/138) — separate bug where `handle_update_from_other` crashes with slot context error in background tasks

## Related

- Dead end: [charspan sync attempt](2026-02-10-dead-end-charspan-sync.md) — documented earlier today, was actually a symptom of this NiceGUI regression, not a fundamental NiceGUI architecture problem
- The dead-end conclusion that "NiceGUI destroy+recreate makes char spans ephemeral" is **only true in 3.7.x**. In 3.6.1 the spans survive.
