# Workspace Navigator Implementation Plan — Phase 1: FTS Infrastructure

**Goal:** Add PostgreSQL full-text search capability to workspace documents via a GIN expression index and a query helper module.

**Architecture:** GIN index on a `to_tsvector` expression over HTML-stripped `workspace_document.content`. No stored column or trigger — the index is maintained automatically by PostgreSQL. A new `db/search.py` module provides the async query interface using `websearch_to_tsquery` for safe user input handling and `ts_headline` for snippet generation.

**Tech Stack:** PostgreSQL FTS (tsvector, GIN index, websearch_to_tsquery, ts_headline), SQLAlchemy 2.x `text()` queries, Alembic manual migration.

**Scope:** 7 phases from original design (phase 1 of 7)

**Codebase verified:** 2026-02-25

**Design deviation:** The design plan specifies a "generated `tsvector` column." PostgreSQL's `to_tsvector()` is not immutable, so it cannot be used in `GENERATED ALWAYS AS STORED` columns. A GIN expression index achieves the same query performance without stored procedures or model changes.

---

## Acceptance Criteria Coverage

This phase implements and tests:

### workspace-navigator-196.AC8: FTS infrastructure
- **workspace-navigator-196.AC8.1 Success:** `workspace_document` table has generated `tsvector` column with GIN index
  - *Adapted:* GIN expression index on `to_tsvector('english', regexp_replace(content, '<[^>]+>', ' ', 'g'))` — equivalent query performance, no stored column.
- **workspace-navigator-196.AC8.2 Success:** HTML tags stripped from indexed content (not indexed as words)
- **workspace-navigator-196.AC8.3 Success:** `ts_headline` returns snippet with matched terms highlighted
- **workspace-navigator-196.AC8.4 Edge:** Short queries (<3 chars) do not trigger FTS
- **workspace-navigator-196.AC8.5 Edge:** Empty document content produces valid (empty) tsvector, no errors

---

## Tasks

<!-- START_SUBCOMPONENT_A (tasks 1-2) -->
<!-- START_TASK_1 -->
### Task 1: Alembic migration — GIN expression index

**Verifies:** workspace-navigator-196.AC8.1, workspace-navigator-196.AC8.2

**Files:**
- Create: `alembic/versions/<generated>_add_fts_gin_index_workspace_document.py`

**Implementation:**

Create migration manually (not autogenerated — Alembic has known issues with FTS expression indexes, see alembic#1390):

```bash
uv run alembic revision -m "add FTS GIN index on workspace_document content"
```

The migration uses `op.execute()` with raw SQL. The expression `to_tsvector('english', regexp_replace(content, '<[^>]+>', ' ', 'g'))` strips HTML tags before indexing.

```python
"""Add FTS GIN index on workspace_document content."""

from collections.abc import Sequence

from alembic import op

revision: str = "<generated>"
down_revision: str | Sequence[str] | None = "e7ae5e81631d"
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
    op.execute(
        "CREATE INDEX idx_workspace_document_fts "
        "ON workspace_document "
        "USING GIN(to_tsvector('english', regexp_replace(content, '<[^>]+>', ' ', 'g')))"
    )


def downgrade() -> None:
    op.execute("DROP INDEX IF EXISTS idx_workspace_document_fts")
```

**Verification:**
Run: `uv run alembic upgrade head`
Expected: Migration applies without errors.

Run: `SELECT indexname FROM pg_indexes WHERE tablename = 'workspace_document' AND indexname = 'idx_workspace_document_fts';`
Expected: One row returned.

**Commit:** `feat: add FTS GIN expression index on workspace_document`
<!-- END_TASK_1 -->

<!-- START_TASK_2 -->
### Task 2: FTS query helper — `db/search.py`

**Verifies:** workspace-navigator-196.AC8.2, workspace-navigator-196.AC8.3, workspace-navigator-196.AC8.4, workspace-navigator-196.AC8.5

**Files:**
- Create: `src/promptgrimoire/db/search.py`
- Test: `tests/integration/test_fts_search.py` (integration — requires PostgreSQL)

**Implementation:**

Create `src/promptgrimoire/db/search.py` with a single public async function:

```python
async def search_workspace_content(
    session: AsyncSession,
    query: str,
    workspace_ids: Sequence[UUID] | None = None,
    limit: int = 50,
) -> list[FTSResult]:
```

Key behaviours:
- Returns early (empty list) if `query.strip()` is fewer than 3 characters (AC8.4).
- Uses `websearch_to_tsquery('english', query)` — safe for any user input, never raises syntax errors.
- The WHERE clause uses the exact GIN index expression: `to_tsvector('english', regexp_replace(content, '<[^>]+>', ' ', 'g')) @@ websearch_to_tsquery('english', :query)`.
- Optionally filters by `workspace_ids` when provided (for scoping results to accessible workspaces).
- Selects `workspace_id`, `ts_headline('english', content, tsquery, 'MaxWords=35, MinWords=15, StartSel=<mark>, StopSel=</mark>')` as snippet, and `ts_rank` for ordering.
- Orders by `ts_rank` descending, limited to `limit` rows.
- Returns a list of `FTSResult` (a NamedTuple or dataclass with `workspace_id: UUID`, `snippet: str`, `rank: float`).

Use `session.execute(text(...), params)` — FTS expressions are not expressible in pure ORM. This follows the project's existing pattern for specialised SQL (see `tags.py:72-76`, `engine.py` diagnostics).

**Testing:**

Tests must verify each AC listed above. Integration tests require a running PostgreSQL database with the FTS index applied.

- workspace-navigator-196.AC8.2: Insert a document with `<p>The quick <b>brown</b> fox</p>`, search for "brown fox" — should match (HTML stripped from index).
- workspace-navigator-196.AC8.3: Search returns `snippet` field containing `<mark>` tags around matched terms.
- workspace-navigator-196.AC8.4: Search with query "ab" (2 chars) returns empty list without hitting the database.
- workspace-navigator-196.AC8.5: Insert a document with empty content `""`, search for any term — no error raised, document simply not in results.

Additional test cases:
- Malformed query input (e.g., `"legal &"`) returns results for "legal" without error.
- `workspace_ids` filter restricts results to specified workspaces.
- Results are ordered by relevance (higher-ranked documents first).

Follow project integration test patterns:
- Module-level skip guard for `DEV__TEST_DATABASE_URL`
- Class-based grouping per function/behaviour
- `@pytest.mark.asyncio` on async tests
- Use `db_session` fixture for fresh `AsyncSession` per test

**Verification:**
Run: `uv run test-changed`
Expected: All new tests pass.

**Commit:** `feat: add FTS query helper for workspace document search`
<!-- END_TASK_2 -->
<!-- END_SUBCOMPONENT_A -->
