# Empty-Tag Annotation UX Design

**GitHub Issue:** #210

## Summary

The annotation workflow in PromptGrimoire has a hard dependency chain: users must have tags before they can create highlights, and highlights before they can add comments. When a workspace is new and has no tags yet, the existing UI presents a dead end -- the floating highlight menu shows a static "No tags available" label with no path forward, and the toolbar buttons give no indication of what they do to a first-time user. This design fixes that discoverability gap without introducing new components or changing the data model.

The changes are purely cosmetic and wiring adjustments within the existing annotation page. The floating highlight menu gains a "+ New" button (visible to users with tag creation permission) that opens the existing quick-create dialog and then auto-applies the newly created tag to the active text selection -- collapsing a two-step flow into one. The toolbar's create and manage buttons display descriptive text labels ("Create New Tag", "Manage Tags") when fewer than five tags exist, switching to compact icon-only style once the toolbar would otherwise become crowded. All action buttons also receive descriptive tooltips. All underlying dialog logic, selection state tracking, and tag persistence mechanisms are reused unchanged.

## Definition of Done

1. **Floating highlight menu provides a path forward when no tags exist** -- users with tag creation permission see a "+ New" button instead of the "No tags available" dead end. Creating a tag via this button auto-applies it to the active text selection.
2. **Toolbar buttons use descriptive labels when space permits** -- "Create New Tag" and "Manage Tags" labels shown when fewer than 5 tags exist; compact to icon-only at 5+ tags.
3. **All action buttons have descriptive tooltips** -- floating menu "+ New", toolbar create, and toolbar manage buttons explain their function on hover.

**Out of scope:** Default/seed tags, changes to the Organise or Respond tabs, tag management dialog changes.

## Acceptance Criteria

### empty-tag-ux-210.AC1: Floating menu guides tag creation
- **AC1.1 Success:** User selects text in a zero-tag workspace with tag creation permission -- floating menu shows a "+ New" button (not "No tags available")
- **AC1.2 Success:** Clicking "+ New" opens the quick-create dialog. After creating a tag, the tag is auto-applied to the selected text as a highlight
- **AC1.3 Success:** When tags already exist, "+ New" appears alongside the tag buttons in the floating menu
- **AC1.4 Failure:** User without tag creation permission in a zero-tag workspace sees "No tags available" with tooltip "Ask your instructor to add tags to this activity"
- **AC1.5 Edge:** User selects text, clicks "+ New", cancels the dialog -- no highlight created, selection state preserved

### empty-tag-ux-210.AC2: Toolbar buttons expand when space permits
- **AC2.1 Success:** With 0-4 tags, toolbar "+" button shows "Create New Tag" with icon
- **AC2.2 Success:** With 0-4 tags, toolbar gear button shows "Manage Tags" with icon
- **AC2.3 Success:** With 5+ tags, both buttons revert to compact icon-only style
- **AC2.4 Edge:** Creating a 5th tag causes toolbar to rebuild with compact buttons (no page reload needed)

### empty-tag-ux-210.AC3: Tooltips on all action buttons
- **AC3.1 Success:** Floating menu "+ New" tooltip: "Create a new tag and apply it to your selection"
- **AC3.2 Success:** Toolbar create button tooltip: "Create a new tag for highlighting and annotating text"
- **AC3.3 Success:** Toolbar manage button tooltip: "Manage tags -- create, edit, reorder, and import tags"
- **AC3.4 Success:** Tooltips display at all tag counts (0, 1-4, 5+)

## Glossary

- **Annotation page**: The main page in PromptGrimoire where users read a document and apply highlights, tags, and comments. Composed of several sub-modules under `pages/annotation/`.
- **Floating highlight menu**: A context menu that appears when a user selects text in the document. Presents available tags as buttons that can be applied to the selection as highlights.
- **Tag**: A user-defined label (with a name and colour) that can be applied to a text selection to create a highlight. Tags belong to a workspace and are managed via the toolbar or quick-create dialog.
- **Highlight**: A coloured annotation applied to a range of text within a workspace document. Created by selecting text and choosing a tag from the floating menu.
- **Toolbar**: The persistent bottom panel in the annotation UI containing tag buttons and the create/manage action buttons.
- **Quick-create dialog** (`tag_quick_create.py`): A modal for creating a single tag without entering the full tag management view. Already invoked from the toolbar "+" button; this design adds a second entry point in the floating menu.
- **Selection state** (`state.selection_start` / `state.selection_end`): Character offsets recording the bounds of the user's most recent text selection. Preserved across dialog interactions; used for auto-applying the newly created tag.
- **CRDT** (Conflict-free Replicated Data Type): The underlying data structure (via `pycrdt`) used to synchronise document annotations across concurrent users. Not changed by this design.
- **NiceGUI**: The Python web UI framework used throughout the application. UI components are constructed in Python using NiceGUI's API.
- **Quasar**: The Vue component library NiceGUI uses under the hood. Relevant here for button shape properties (`round` vs standard) and compact styling modifiers.
- **Workspace**: A single student or instructor document instance within an activity, containing the text content and all associated annotations.
- **Tag creation permission**: Access control governing whether a user may create new tags. Determines whether the floating menu shows "+ New" or the static "No tags available" label.

## Architecture

Improve annotation page discoverability when a workspace has zero tags. The entire annotation workflow is a dependency chain (tags -> highlights -> comments); when the first link is missing, users hit a dead end with no guidance. This design adds inline calls-to-action and expanded labels so users can discover the tag creation flow organically.

All changes are UI-only within the existing annotation page. No new components, no data model changes, no new dependencies.

**Components affected:**

| Component | File | Change |
|-----------|------|--------|
| Highlight menu population | `pages/annotation/document.py` (`_populate_highlight_menu`, line 113) | Add "+ New" button when `on_add_click` available; replace dead-end label |
| Highlight menu builder | `pages/annotation/document.py` (`_build_highlight_menu`, line 160) | Thread `on_add_click` callback through to population function |
| Toolbar "+" button | `pages/annotation/css.py` (`_build_tag_toolbar`, line 425) | Conditional label: "Create New Tag" when < 5 tags, icon-only at 5+ |
| Toolbar gear button | `pages/annotation/css.py` (`_build_tag_toolbar`, line 433) | Conditional label: "Manage Tags" when < 5 tags, icon-only at 5+ |
| Toolbar/menu tooltips | `pages/annotation/css.py` and `document.py` | Descriptive tooltips on all action buttons |
| Tag callback wiring | `pages/annotation/workspace.py` (`_create_tag_callbacks`, line 348) | Pass `on_add_click` to highlight menu; floating menu variant auto-applies created tag to saved selection |

**Data flow:** No change to CRDT sync, tag persistence, or highlight creation. The existing `open_quick_create(state)` dialog and `_rebuild_toolbar()` flow are reused. The floating menu's "+ New" adds a post-creation step: apply the new tag to `state.selection_start`/`state.selection_end`.

## Existing Patterns

Investigation confirmed the annotation page already has the building blocks for this design:

- **Quick-create dialog** (`tag_quick_create.py`) opens from the toolbar "+" button, creates a tag, and triggers `_rebuild_toolbar()`. This design reuses the same dialog from a second entry point (the floating menu).
- **Selection state preservation** -- `state.selection_start` and `state.selection_end` are set in `on_selection()` (document.py:36-44) and persist until the next selection. The quick-create flow already saves these positions (quick_create.py:93-94). Auto-apply reads them after dialog close.
- **Toolbar button styling** -- existing buttons use `.classes("compact-btn").props("round dense flat color=grey-7")` with `.tooltip()`. The expanded label variant changes `round` to standard button shape and adds text.
- **Tooltip pattern** -- both toolbar buttons already have tooltips ("Create new tag", "Manage tags"). This design updates the text and adds a tooltip to the floating menu's "+ New" button.

No new patterns introduced. All changes follow existing conventions.

## Implementation Phases

<!-- START_PHASE_1 -->
### Phase 1: Floating Menu "+ New" Button

**Goal:** Replace the "No tags available" dead end with an actionable "+ New" button that creates a tag and auto-applies it to the selection.

**Components:**
- `_populate_highlight_menu()` in `pages/annotation/document.py` -- when `state.tag_info_list` is empty and `on_add_click` is available, render a "+ New" button instead of the static label. When user lacks permission and no tags exist, keep the label but add a tooltip ("Ask your instructor to add tags to this activity").
- `_build_highlight_menu()` in `pages/annotation/document.py` -- accept and thread `on_add_click` callback.
- Floating menu callback in `pages/annotation/workspace.py` -- variant of `on_add_tag` that, after `open_quick_create()` returns, also applies the newly created tag to `state.selection_start`/`state.selection_end` and repopulates the highlight menu.
- The "+ New" button should also appear when tags DO exist (after the tag buttons), so users can always create a tag inline while highlighting.
- **Visual styling:** "+ New" renders with transparent background and neutral text (grey), not a full-colour tag-style background. This distinguishes it as an action button, not a tag.

**Dependencies:** None

**Done when:** User selects text in a zero-tag workspace, sees "+ New" button, creates a tag, and the tag is auto-applied to their selection. Floating menu also shows "+ New" alongside existing tag buttons when tags exist. Covers `empty-tag-ux-210.AC1.*`.
<!-- END_PHASE_1 -->

<!-- START_PHASE_2 -->
### Phase 2: Toolbar Expanded Labels and Tooltips

**Goal:** Make toolbar buttons self-describing when space permits (< 5 tags).

**Components:**
- "+" button in `_build_tag_toolbar()` (`pages/annotation/css.py`, line 425) -- when `len(tag_info_list) < 5`: render as a standard (non-round) button with text "Create New Tag" and icon "add". At 5+ tags: revert to current compact icon-only style. Tooltip: "Create a new tag for highlighting and annotating text".
- Gear button in `_build_tag_toolbar()` (`pages/annotation/css.py`, line 433) -- when `len(tag_info_list) < 5`: render with text "Manage Tags" and icon "settings". At 5+ tags: revert to current compact icon-only style. Tooltip: "Manage tags -- create, edit, reorder, and import tags".
- Pass `tag_info_list` length (already available as parameter) to the conditional rendering.
- **Threshold note:** The 5-tag breakpoint is a pragmatic default. Extract it as a named constant (e.g. `_COMPACT_THRESHOLD = 5`) so it's easy to adjust after user testing.

**Dependencies:** None (can be implemented in parallel with Phase 1)

**Done when:** Toolbar shows expanded labels with < 5 tags. Compact icon-only with 5+ tags. Tooltips present at all tag counts. Covers `empty-tag-ux-210.AC2.*`, `empty-tag-ux-210.AC3.*`.
<!-- END_PHASE_2 -->
