# Annotation Tags QA Pass Design

**GitHub Issue:** #95 (PR #182)

## Summary

The annotation tags feature (issue #95) lets instructors define coloured, labelled tags on template workspaces; students inherit those tags when their workspace is cloned, and can highlight conversation turns to apply them. This QA pass (PR #182) does not add new capabilities -- it hardens what was already built. The work falls into three streams: first, fixing E2E tests that are currently broken because standalone test workspaces are created without any tags, by introducing a sync database helper that seeds a standard tag set before each test runs; second, closing a race condition in tag creation, where two concurrent requests could both read the same maximum `order_index` and produce a duplicate, by replacing that pattern with an atomic counter column on the workspace row; third, improving code quality through a CHECK constraint on tag group colours, filling gaps in integration test coverage, and splitting a 1090-line module into five files along functional lines.

The implementation is sequenced so that E2E infrastructure is fixed first, then new E2E subtests exercise the full instructor-creates-tags -> student-clones-and-annotates flow, then the race condition fix and integration test gaps are addressed independently, and finally the refactor is applied last -- at which point all tests are green and regressions from the file split are immediately visible.

## Definition of Done

PR #182 is complete when:

1. **E2E tests pass** -- the 9 currently broken test files work again (tag seeding for standalone workspaces), plus new subtests exercise tag-specific ACs from the human test plan.
2. **Full instructor->student tag flow tested E2E** -- extend `test_instructor_workflow.py` with subtests: instructor creates tags on template, student clones and sees them.
3. **Race condition fixed** -- `create_tag` and `create_tag_group` use counter columns on `workspace` (`next_tag_order`, `next_group_order`) to atomically claim `order_index` values, preventing duplicates under concurrent access.
4. **4 Important review issues resolved** -- CHECK constraint on `tag_group.color` (Alembic migration), `bypass_lock` tested, `delete_tag` not-found tested, `import_tags` ValueError tested.
5. **Refactor `tag_management.py`** -- split ~1090-line file into 5 files by dialog type (`tag_quick_create.py`, `tag_import.py`, `tag_management_rows.py`, `tag_management_save.py`, `tag_management.py` orchestrator), collapse duplicate confirm dialogs, address `Any` types.
6. **5 remaining Minor review issues resolved** -- dead JS `regionPriority` removed, integration test gaps filled (`update_tag_group` color sentinel, `reorder` ValueError paths).
7. **All tests pass, ty clean, ruff clean.**

Out of scope: no new tag features -- this is exclusively testing, hardening, and refactoring of existing code.

## Acceptance Criteria

### tags-qa-95.AC1: Broken E2E tests fixed
- **tags-qa-95.AC1.1 Success:** All 9 previously-broken E2E test files pass with tag seeding enabled
- **tags-qa-95.AC1.2 Success:** `create_highlight_with_tag()` finds toolbar buttons at expected indices after seeding
- **tags-qa-95.AC1.3 Success:** Seeding is idempotent -- calling `_seed_tags_for_workspace` twice does not create duplicate tags
- **tags-qa-95.AC1.4 Success:** `setup_workspace_with_content(seed_tags=False)` creates workspace without tags

### tags-qa-95.AC2: Instructor tag flow tested E2E
- **tags-qa-95.AC2.1 Success:** Instructor creates tag via quick-create ("+"), tag appears in toolbar
- **tags-qa-95.AC2.2 Success:** Instructor adds tags via management dialog, tags persist after dialog close
- **tags-qa-95.AC2.3 Success:** Instructor locks a tag, lock icon visible in management dialog
- **tags-qa-95.AC2.4 Success:** Instructor reorders tag groups, new order persists across dialog close/reopen
- **tags-qa-95.AC2.5 Success:** Instructor imports tags into a second activity's template workspace

### tags-qa-95.AC3: Student clone verification tested E2E
- **tags-qa-95.AC3.1 Success:** Student toolbar shows cloned tags with correct names after workspace clone
- **tags-qa-95.AC3.2 Success:** Locked tag shows lock icon and disabled fields in student management dialog
- **tags-qa-95.AC3.3 Success:** Student edits unlocked tag name, change persists via blur-save
- **tags-qa-95.AC3.4 Success:** Student reorders tags, new order persists across dialog close/reopen
- **tags-qa-95.AC3.5 Success:** Keyboard shortcut `2` creates highlight with tag at reordered position 2
- **tags-qa-95.AC3.6 Success:** Keyboard shortcut `3` creates highlight with tag at reordered position 3

### tags-qa-95.AC4: Keyboard shortcut isolation tested E2E
- **tags-qa-95.AC4.1 Success:** Typing `1` in comment input inserts the character "1" into the field
- **tags-qa-95.AC4.2 Failure:** Typing `1` in comment input does NOT create a new highlight
- **tags-qa-95.AC4.3 Failure:** Pressing `a` with text selected does NOT create a highlight
- **tags-qa-95.AC4.4 Success:** Organise tab has no "Untagged" column header

### tags-qa-95.AC5: Race condition fixed
- **tags-qa-95.AC5.1 Success:** `workspace` table has `next_tag_order` and `next_group_order` columns
- **tags-qa-95.AC5.2 Success:** `create_tag` atomically claims order index via counter column UPDATE+RETURNING
- **tags-qa-95.AC5.3 Success:** `create_tag_group` atomically claims order index via counter column UPDATE+RETURNING
- **tags-qa-95.AC5.4 Success:** Two concurrent `create_tag` calls produce distinct `order_index` values
- **tags-qa-95.AC5.5 Success:** Counter correct after `reorder_tags` -- subsequent create uses next available index

### tags-qa-95.AC6: Integration test gaps filled
- **tags-qa-95.AC6.1 Success:** `tag_group.color` CHECK constraint rejects invalid hex
- **tags-qa-95.AC6.2 Success:** `tag_group.color` CHECK constraint allows NULL
- **tags-qa-95.AC6.3 Success:** `update_tag` with `bypass_lock=True` succeeds on locked tag
- **tags-qa-95.AC6.4 Success:** `delete_tag` with `bypass_lock=True` succeeds on locked tag
- **tags-qa-95.AC6.5 Success:** `delete_tag` with nonexistent UUID returns False
- **tags-qa-95.AC6.6 Failure:** `import_tags_from_activity` with nonexistent activity raises ValueError
- **tags-qa-95.AC6.7 Success:** `update_tag_group(color=None)` clears group colour
- **tags-qa-95.AC6.8 Success:** `update_tag_group` without `color` preserves existing colour
- **tags-qa-95.AC6.9 Failure:** `reorder_tags` with unknown tag UUID raises ValueError
- **tags-qa-95.AC6.10 Failure:** `reorder_tag_groups` with unknown group UUID raises ValueError

### tags-qa-95.AC7: Refactor complete
- **tags-qa-95.AC7.1 Success:** `tag_management.py` split into 5 files, no file exceeds ~400 lines
- **tags-qa-95.AC7.2 Success:** Import graph between tag management files is one-way
- **tags-qa-95.AC7.3 Success:** `regionPriority()` dead code removed from `annotation-highlight.js`
- **tags-qa-95.AC7.4 Success:** All existing tests pass after refactor
- **tags-qa-95.AC7.5 Success:** Module count in `__init__.py` and package structure test updated

## Glossary

- **E2E test (end-to-end test)**: A test that drives a real browser against a running server using Playwright, verifying the full stack from UI interaction to database persistence.
- **Playwright**: A browser automation library used here to write E2E tests; controls a headless Chromium browser.
- **standalone workspace**: A workspace created directly by an E2E test helper (not via the course-clone flow). Starts with no tags, which was the root cause of the broken tests.
- **NiceGUI**: The Python web UI framework; renders pages server-side and syncs state to the browser via WebSockets.
- **SQLModel**: The ORM layer combining Pydantic (validation) and SQLAlchemy (SQL generation).
- **Alembic**: The database schema migration tool; the only sanctioned way to add or modify tables in this project.
- **READ COMMITTED isolation**: PostgreSQL default transaction isolation; two concurrent transactions can each read committed data, meaning neither sees the other's in-progress writes.
- **counter column / atomic counter**: A column incremented with `UPDATE ... SET col = col + 1 RETURNING col - 1`, which the database executes atomically with row-level locking.
- **`ON CONFLICT DO NOTHING`**: A PostgreSQL `INSERT` clause that silently skips rows violating a unique constraint; used to make tag seeding idempotent.
- **CHECK constraint**: A database-level rule that rejects rows whose column values fail a condition.
- **`bypass_lock`**: A parameter on tag CRUD functions that lets privileged callers modify or delete locked tags.
- **blur-save**: The pattern where an input field saves its value on focus loss (`blur` event) rather than requiring an explicit Save button.
- **`data-testid`**: An HTML attribute added to elements for stable E2E test selectors; not visible to users.
- **import graph (one-way)**: A constraint that module A may import from B but B must not import from A, preventing circular imports.
- **dead code**: Code that is defined but never called; `regionPriority()` in `annotation-highlight.js` is the specific instance.
- **psycopg**: PostgreSQL sync driver for Python; used in E2E helpers because they run outside the async event loop.
- **xdist**: A pytest plugin that distributes tests across multiple worker processes.

## Architecture

This is a QA pass on the existing tag architecture from `2026-02-17-annotation-tags-95.md`. No new features. Three work streams:

1. **E2E test infrastructure** -- sync DB helper seeds tags into standalone workspaces so existing tests work; new subtests exercise instructor tag creation, student clone verification, keyboard shortcuts, and reorder persistence.
2. **Race condition hardening** -- counter columns on `workspace` table replace racy `SELECT max(order_index)` + `INSERT` pattern in `create_tag` and `create_tag_group`.
3. **Code quality** -- Alembic migration for `tag_group.color` CHECK constraint, `tag_management.py` split into 5 files, dead JS cleanup, missing integration test coverage.

### E2E Tag Seeding

Standalone workspaces (created by `setup_workspace_with_content()` and `_load_fixture_via_paste()` in `tests/e2e/annotation_helpers.py`) have zero tags after creation. A sync DB helper `_seed_tags_for_workspace(workspace_id)` in `tests/e2e/conftest.py` inserts the Legal Case Brief tag set (3 groups, 10 tags) using raw SQL with `ON CONFLICT DO NOTHING` for idempotency. Follows the `_grant_workspace_access()` pattern (sync psycopg engine, `os.environ["DATABASE__URL"]`).

Wired into both helper functions via `seed_tags=True` default parameter. After workspace URL is available, extract workspace_id, seed, `page.reload()`, `wait_for_text_walker()`.

### Race Condition Fix

`create_tag` and `create_tag_group` in `src/promptgrimoire/db/tags.py` currently compute `order_index` via `SELECT max(order_index) WHERE workspace_id = X`. Under READ COMMITTED isolation with NiceGUI's single-event-loop concurrency, two coroutines can interleave at `await` points and both read the same max, producing duplicate indices.

Fix: add `next_tag_order` and `next_group_order` integer columns (default 0) to the `workspace` table via Alembic migration. `create_tag` does `UPDATE workspace SET next_tag_order = next_tag_order + 1 WHERE id = :ws RETURNING next_tag_order - 1` to atomically claim the next index. The UPDATE locks the workspace row, serialising concurrent inserts. The workspace row always exists (created before any tags), so the zero-rows edge case that defeats `SELECT ... FOR UPDATE` on the tag table is avoided.

Data migration: set `next_tag_order` to `SELECT count(*) FROM tag WHERE workspace_id = workspace.id` and `next_group_order` similarly for existing workspaces.

### Refactor: tag_management.py Split

Split `src/promptgrimoire/pages/annotation/tag_management.py` (~1090 lines) into 5 files by dialog type:

| File | Contents | ~Lines |
|------|----------|--------|
| `tag_quick_create.py` | `_build_colour_picker()`, `open_quick_create()` | ~165 |
| `tag_import.py` | `_render_import_section()` | ~60 |
| `tag_management_rows.py` | `_render_tag_row()`, `_render_group_header()`, `_open_confirm_delete()` (collapsed), `_render_group_tags()`, `_render_tag_list_content()` | ~370 |
| `tag_management_save.py` | `_refresh_tag_state()`, `_save_single_tag()`, `_save_single_group()` | ~130 |
| `tag_management.py` | `TagRowInputs`, `_PRESET_PALETTE`, reorder helpers, `open_tag_management()`, `_build_*_callbacks()` | ~335 |

Import graph (one-way): `tag_management.py` (orchestrator) imports from `_rows`, `_save`, `_import`; `_rows` imports from `_save` for blur handlers. `tag_quick_create.py` is independent.

Collapse `_open_confirm_delete_tag` and `_open_confirm_delete_group` into a single `_open_confirm_delete()` with parameterised message and delete function.

## Existing Patterns

### E2E Test Seeding

`_grant_workspace_access()` in `tests/e2e/conftest.py` -- plain function (not a fixture), sync SQLAlchemy with psycopg driver, `engine.begin()` auto-commit, `engine.dispose()` after use. New `_seed_tags_for_workspace()` follows this exactly.

`_pre_test_db_cleanup()` in `src/promptgrimoire/cli.py` -- runs Alembic migrations and truncates tables before pytest starts. Tag seeding happens later (per-workspace, after each test creates its workspace), not here.

### Tag CRUD

`create_tag()` and `create_tag_group()` in `src/promptgrimoire/db/tags.py` -- async functions using `get_session()`. The counter column approach replaces the `SELECT max() + INSERT` pattern but keeps the same function signatures.

### Module Structure

Annotation page modules in `src/promptgrimoire/pages/annotation/` follow single-responsibility: `document.py` (highlight menu), `workspace.py` (toolbar/tabs), `css.py` (styles), `sidebar.py` (annotation cards). The tag management split continues this pattern.

### data-testid Convention

Existing E2E-targeted elements use `data-testid` attributes (`tag-toolbar`, `annotation-card`, `highlight-menu`, `organise-columns`). New test-ids for the management dialog follow this convention.

## Implementation Phases

<!-- START_PHASE_1 -->
### Phase 1: E2E Tag Seeding Infrastructure
**Goal:** Fix all 9 broken E2E test files by seeding tags into standalone workspaces.

**Components:**
- `_seed_tags_for_workspace()` sync DB helper in `tests/e2e/conftest.py`
- `seed_tags` parameter wired into `setup_workspace_with_content()` and `_load_fixture_via_paste()` in `tests/e2e/annotation_helpers.py`
- `data-testid` attributes added to tag management dialog elements in `src/promptgrimoire/pages/annotation/tag_management.py` (for Phase 2)

**Dependencies:** None (first phase)

**Done when:** `uv run test-e2e` passes -- all previously-broken tests find toolbar buttons and create highlights successfully.
<!-- END_PHASE_1 -->

<!-- START_PHASE_2 -->
### Phase 2: Instructor Workflow E2E Subtests
**Goal:** Exercise the full instructor-creates-tags â†’ student-clones-and-uses flow via Playwright.

**Components:**
- New subtests in `tests/e2e/test_instructor_workflow.py::TestInstructorWorkflow::test_full_course_setup`:
  - `create_tag_via_quick_create` -- instructor creates "Jurisdiction" tag via "+" button
  - `open_management_and_add_tags` -- gear icon, add "Facts" and "Holding" via management dialog
  - `lock_tag_on_template` -- lock "Jurisdiction" in management dialog
  - `reorder_tag_groups` -- drag group to new position, verify persistence
  - `import_tags_to_another_activity` -- create second activity, import tags from first
  - `student_sees_cloned_tags` -- after clone, toolbar has 3 tags with correct names
  - `student_locked_tag_readonly` -- management dialog shows lock icon, fields disabled
  - `student_edits_unlocked_tag` -- rename "Facts" to "Key Facts", verify blur-save persistence
  - `student_reorders_tags` -- drag "Holding" above "Key Facts", verify order persists
  - `student_highlights_with_reordered_tag` -- select text, press `2` (keyboard), verify highlight uses "Holding" (reordered position), press `3`, verify "Key Facts"
- Course helpers in `tests/e2e/course_helpers.py` if needed for second-activity creation

**Dependencies:** Phase 1 (data-testid attributes on management dialog)

**Done when:** All new subtests pass. Instructor tag lifecycle (create, lock, reorder, import) and student clone verification (tags visible, locked tag readonly, reorder persists, keyboard shortcuts map to reordered position) all exercise via Playwright. Covers tags-qa-95.AC2.*, tags-qa-95.AC3.*.
<!-- END_PHASE_2 -->

<!-- START_PHASE_3 -->
### Phase 3: Law Student & Persona Subtests
**Goal:** Add targeted tag-specific subtests to existing persona tests.

**Components:**
- New subtests in `tests/e2e/test_law_student.py::TestLawStudent::test_austlii_annotation_workflow`:
  - `keyboard_shortcut_in_input_field` -- focus comment input, type `1`, verify character appears in input (not intercepted), verify no new highlight
  - `letter_key_no_highlight` -- select text, press `a`, verify no highlight created
  - `no_untagged_column_in_organise` -- navigate to Organise tab, assert no "Untagged" column header

**Dependencies:** Phase 1 (tag seeding)

**Done when:** All new subtests pass. Keyboard shortcut isolation (issue #127) verified end-to-end. Covers tags-qa-95.AC4.*.
<!-- END_PHASE_3 -->

<!-- START_PHASE_4 -->
### Phase 4: Race Condition Fix
**Goal:** Eliminate duplicate `order_index` under concurrent tag/group creation.

**Components:**
- Alembic migration: add `next_tag_order` (int, default 0) and `next_group_order` (int, default 0) columns to `workspace` table. Data migration populates from existing tag/group counts.
- `src/promptgrimoire/db/tags.py`: `create_tag()` and `create_tag_group()` use `UPDATE workspace SET next_*_order = next_*_order + 1 RETURNING next_*_order - 1` instead of `SELECT max(order_index)`
- `src/promptgrimoire/db/models.py`: add columns to Workspace model
- Integration tests in `tests/integration/test_tag_crud.py`: verify concurrent creation produces distinct order indices

**Dependencies:** None (independent of E2E work)

**Done when:** `create_tag` and `create_tag_group` atomically claim order indices. Integration test with concurrent coroutines confirms no duplicate indices. Covers tags-qa-95.AC5.*.
<!-- END_PHASE_4 -->

<!-- START_PHASE_5 -->
### Phase 5: CHECK Constraint + Integration Test Gaps
**Goal:** Add missing DB constraint and fill integration test coverage gaps.

**Components:**
- Alembic migration: `ck_tag_group_color_hex` CHECK constraint on `tag_group.color` (`color IS NULL OR color ~ '^#[0-9a-fA-F]{6}$'`)
- `src/promptgrimoire/db/models.py`: add `CheckConstraint` to `TagGroup.__table_args__`
- New tests in `tests/integration/test_tag_schema.py`: invalid group colour rejected
- New tests in `tests/integration/test_tag_crud.py`:
  - `bypass_lock` on update and delete
  - `delete_tag` with nonexistent ID returns False
  - `import_tags_from_activity` with nonexistent activity raises ValueError
  - `update_tag_group` color sentinel (explicit None clears, omitted preserves)
  - `reorder_tags` and `reorder_tag_groups` with bad IDs raise ValueError

**Dependencies:** None (independent)

**Done when:** All new integration tests pass. CHECK constraint enforced at DB level. Covers tags-qa-95.AC6.*.
<!-- END_PHASE_5 -->

<!-- START_PHASE_6 -->
### Phase 6: Refactor + Dead Code Cleanup
**Goal:** Split `tag_management.py` into 5 files, remove dead JS, address Any types.

**Components:**
- Split `src/promptgrimoire/pages/annotation/tag_management.py` into:
  - `tag_quick_create.py`
  - `tag_import.py`
  - `tag_management_rows.py`
  - `tag_management_save.py`
  - `tag_management.py` (orchestrator)
- Collapse `_open_confirm_delete_tag` and `_open_confirm_delete_group` into shared `_open_confirm_delete()`
- Update imports in `src/promptgrimoire/pages/annotation/workspace.py`
- Update module count in `src/promptgrimoire/pages/annotation/__init__.py` and `tests/unit/test_annotation_package_structure.py`
- Remove dead `regionPriority()` in `src/promptgrimoire/static/annotation-highlight.js:166-172`
- Address `Any` typed callback parameters where NiceGUI provides concrete types

**Dependencies:** Phases 1-3 complete (E2E tests verify no regressions from refactor)

**Done when:** No file over ~370 lines. Import graph is one-way. All existing tests pass unchanged. `regionPriority` dead code removed. Covers tags-qa-95.AC7.*.
<!-- END_PHASE_6 -->

## Additional Considerations

**E2E test isolation:** Each test creates its own workspace via the UI, so tag seeding is per-workspace. The idempotent guard (`ON CONFLICT DO NOTHING`) prevents clobbering tags created by the instructor UI flow in Phase 2 tests.

**Counter column migration:** Existing workspaces need `next_tag_order` and `next_group_order` populated from current tag/group counts. New workspaces start at 0. The `reorder_tags` and `reorder_tag_groups` functions should also update the counter to `max(new_order_indices) + 1` so subsequent creates produce correct values after a reorder.

**Seed helper must update counters:** `_seed_tags_for_workspace()` inserts tags via raw SQL, bypassing the counter column mechanism. After inserting, it must set `next_tag_order` and `next_group_order` on the workspace row to match the number of seeded tags/groups. Otherwise the first real `create_tag` call will claim `order_index = 0`, colliding with seeded data.

**CHECK constraint data validation:** The `ck_tag_group_color_hex` CHECK (`color IS NULL OR color ~ '^#[0-9a-fA-F]{6}$'`) requires all existing `tag_group.color` values to satisfy the regex before the migration applies. All code paths (preset palette, `ui.color_input`, seed data) produce 6-digit hex. The migration should include an assertion query (`SELECT count(*) FROM tag_group WHERE color IS NOT NULL AND color !~ '^#[0-9a-fA-F]{6}$'`) to fail early with a clear message rather than a raw constraint violation.

**Refactor safety:** The 5-file split is a pure move refactor -- no logic changes. All existing tests serve as regression coverage. The refactor phase runs AFTER E2E tests are green so regressions are immediately detectable.
