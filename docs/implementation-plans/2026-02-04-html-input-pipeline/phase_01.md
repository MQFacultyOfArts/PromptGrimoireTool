# HTML Input Pipeline - Phase 1: Schema Changes

**Goal:** Update WorkspaceDocument schema to remove `raw_content` and add `source_type` field.

**Architecture:** Alembic migration modifies the workspace_document table. Model and CRUD function updated to match.

**Tech Stack:** SQLModel, Alembic, PostgreSQL

**Scope:** Phase 1 of 8 from original design

**Codebase verified:** 2026-02-05

---

## Codebase Verification Findings

| Assumption | Result | Actual |
|------------|--------|--------|
| Model in `src/promptgrimoire/models/` | ✗ Differs | `src/promptgrimoire/db/models.py:182-207` |
| `raw_content` field exists | ✓ Confirmed | Line 203, actively used in 11 locations |
| `source_type` field exists | ✗ Missing | To be added in this phase |
| `create_workspace_document()` | ✗ Differs | Function is `add_document()` at `db/workspace_documents.py:17-57` |
| Alembic migrations | ✓ Confirmed | 13 migrations, naming: `{hash}_{snake_desc}.py` |

**Critical paths:**
- Model: `src/promptgrimoire/db/models.py`
- CRUD: `src/promptgrimoire/db/workspace_documents.py`
- Migrations: `alembic/versions/`
- Test fixture: `tests/unit/conftest.py`

---

<!-- START_SUBCOMPONENT_A (tasks 1-4) -->

<!-- START_TASK_1 -->
### Task 1: Create Alembic migration to add source_type and remove raw_content

**Files:**
- Create: `alembic/versions/{revision}_add_source_type_remove_raw_content.py`

**Step 1: Generate migration scaffold**

Run:
```bash
cd /home/brian/people/Brian/PromptGrimoire/.worktrees/html-input-pipeline && uv run alembic revision --autogenerate -m "add_source_type_remove_raw_content"
```

Expected: Creates new migration file in `alembic/versions/`

**Step 2: Edit generated migration to handle data migration**

The autogenerated migration will need manual adjustment. Replace the `upgrade()` and `downgrade()` functions with:

```python
"""add_source_type_remove_raw_content

Revision ID: {generated}
Revises: fe6d5d784dab
Create Date: 2026-02-05
"""

from collections.abc import Sequence

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "{generated}"
down_revision: str | None = "fe6d5d784dab"
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
    # Add source_type column with default for existing rows
    op.add_column(
        "workspace_document",
        sa.Column("source_type", sa.String(length=20), nullable=False, server_default="text"),
    )
    # Remove the server default after adding (we want app to supply it)
    op.alter_column("workspace_document", "source_type", server_default=None)

    # Drop raw_content column
    op.drop_column("workspace_document", "raw_content")


def downgrade() -> None:
    # Add raw_content back (will be empty for new rows)
    op.add_column(
        "workspace_document",
        sa.Column("raw_content", sa.Text(), nullable=False, server_default=""),
    )
    op.alter_column("workspace_document", "raw_content", server_default=None)

    # Drop source_type
    op.drop_column("workspace_document", "source_type")
```

**Step 3: Run migration to verify it works**

Run:
```bash
cd /home/brian/people/Brian/PromptGrimoire/.worktrees/html-input-pipeline && uv run alembic upgrade head
```

Expected: Migration completes without errors

**Step 4: Verify schema change**

Run:
```bash
cd /home/brian/people/Brian/PromptGrimoire/.worktrees/html-input-pipeline && uv run alembic current
```

Expected: Shows the new revision as current

<!-- END_TASK_1 -->

<!-- START_TASK_2 -->
### Task 2: Update WorkspaceDocument model

**Files:**
- Modify: `src/promptgrimoire/db/models.py:182-207`

**Step 1: Update model definition**

In `src/promptgrimoire/db/models.py`, find the `WorkspaceDocument` class (lines 182-207) and update it:

**Remove this line (around line 203):**
```python
    raw_content: str = Field(sa_column=Column(sa.Text(), nullable=False))
```

**Add this line after the `content` field (around line 201):**
```python
    source_type: str = Field(max_length=20)  # "html", "rtf", "docx", "pdf", "text"
```

**The updated class should look like:**
```python
class WorkspaceDocument(SQLModel, table=True):
    """A document within a workspace (source, draft, AI conversation)."""

    __tablename__ = "workspace_document"

    id: UUID = Field(default_factory=uuid4, primary_key=True)
    workspace_id: UUID = Field(sa_column=_cascade_fk_column("workspace.id"))
    type: str = Field(max_length=50)
    content: str = Field(sa_column=Column(sa.Text(), nullable=False))
    source_type: str = Field(max_length=20)  # "html", "rtf", "docx", "pdf", "text"
    order_index: int = Field(default=0)
    title: str | None = Field(default=None, max_length=500)
    created_at: datetime = Field(
        default_factory=lambda: datetime.now(UTC),
        sa_column=Column(DateTime(timezone=True), nullable=False),
    )
```

**Step 2: Verify model compiles**

Run:
```bash
cd /home/brian/people/Brian/PromptGrimoire/.worktrees/html-input-pipeline && uv run python -c "from promptgrimoire.db.models import WorkspaceDocument; print('OK')"
```

Expected: Prints "OK" without errors

<!-- END_TASK_2 -->

<!-- START_TASK_3 -->
### Task 3: Update add_document() function

**Files:**
- Modify: `src/promptgrimoire/db/workspace_documents.py:17-57`

**Step 1: Update function signature and implementation**

In `src/promptgrimoire/db/workspace_documents.py`, update the `add_document` function:

**Change signature from:**
```python
async def add_document(
    workspace_id: UUID,
    type: str,
    content: str,
    raw_content: str,
    title: str | None = None,
) -> WorkspaceDocument:
```

**To:**
```python
async def add_document(
    workspace_id: UUID,
    type: str,
    content: str,
    source_type: str,
    title: str | None = None,
) -> WorkspaceDocument:
```

**Update the docstring to replace:**
```python
        raw_content: The raw/original content (for word tokenization).
```

**With:**
```python
        source_type: Content type - "html", "rtf", "docx", "pdf", or "text".
```

**Update the model instantiation (around line 50-55) from:**
```python
    doc = WorkspaceDocument(
        workspace_id=workspace_id,
        type=type,
        content=content,
        raw_content=raw_content,
        order_index=next_order,
        title=title,
    )
```

**To:**
```python
    doc = WorkspaceDocument(
        workspace_id=workspace_id,
        type=type,
        content=content,
        source_type=source_type,
        order_index=next_order,
        title=title,
    )
```

**Step 2: Verify function compiles**

Run:
```bash
cd /home/brian/people/Brian/PromptGrimoire/.worktrees/html-input-pipeline && uv run python -c "from promptgrimoire.db.workspace_documents import add_document; print('OK')"
```

Expected: Prints "OK" without errors

<!-- END_TASK_3 -->

<!-- START_TASK_4 -->
### Task 4: Update test fixture and fix broken tests

**Files:**
- Modify: `tests/unit/conftest.py:40-55` (make_workspace_document fixture)
- Modify: `tests/integration/test_workspace_crud.py` (any raw_content references)

**Step 1: Update make_workspace_document fixture**

In `tests/unit/conftest.py`, find the `make_workspace_document` function (around line 40-55):

**Change the signature from:**
```python
def make_workspace_document(
    workspace_id: UUID = STANDARD_WORKSPACE_ID,
    type: str = "source",
    content: str = "Test content",
    raw_content: str = "Test content",
    title: str | None = None,
) -> WorkspaceDocument:
```

**To:**
```python
def make_workspace_document(
    workspace_id: UUID = STANDARD_WORKSPACE_ID,
    type: str = "source",
    content: str = "Test content",
    source_type: str = "text",
    title: str | None = None,
) -> WorkspaceDocument:
```

**Update the return statement from:**
```python
    return WorkspaceDocument(
        workspace_id=workspace_id,
        type=type,
        content=content,
        raw_content=raw_content,
        title=title,
    )
```

**To:**
```python
    return WorkspaceDocument(
        workspace_id=workspace_id,
        type=type,
        content=content,
        source_type=source_type,
        title=title,
    )
```

**Step 2: Search for and fix raw_content references in integration tests**

Run:
```bash
cd /home/brian/people/Brian/PromptGrimoire/.worktrees/html-input-pipeline && grep -rn "raw_content" tests/
```

Fix any remaining `raw_content` references by replacing with `source_type="text"` or similar.

**Step 3: Run tests to verify**

Run:
```bash
cd /home/brian/people/Brian/PromptGrimoire/.worktrees/html-input-pipeline && uv run pytest tests/unit/test_workspace_models.py tests/integration/test_workspace_crud.py -v
```

Expected: All tests pass

**Step 4: Commit**

```bash
cd /home/brian/people/Brian/PromptGrimoire/.worktrees/html-input-pipeline && git add alembic/versions/ src/promptgrimoire/db/models.py src/promptgrimoire/db/workspace_documents.py tests/unit/conftest.py tests/integration/test_workspace_crud.py && git commit -m "feat(schema): add source_type, remove raw_content from WorkspaceDocument

- Add Alembic migration for schema change
- Update WorkspaceDocument model
- Update add_document() function signature
- Update test fixtures

Part of #106 HTML input pipeline

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

<!-- END_TASK_4 -->

<!-- END_SUBCOMPONENT_A -->

---

## Phase 1 Completion Criteria

- [ ] Alembic migration created and runs successfully
- [ ] WorkspaceDocument model has `source_type`, no `raw_content`
- [ ] `add_document()` accepts `source_type` parameter
- [ ] Test fixture updated
- [ ] All unit and integration tests pass
- [ ] Changes committed
